<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>VALIDATOR - V 1.27</title>

  <!-- ===========================
       FUENTES
  ============================ -->
  <style>
    @font-face {
      font-family: "Apercu Regular";
      src: url("FONTS/apercu_regular_movistar-web.woff2") format("woff2"),
           url("FONTS/apercu_regular_movistar-web.woff") format("woff");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "Apercu Bold";
      src: url("FONTS/apercu_bold_movistar-web.woff2") format("woff2"),
           url("FONTS/apercu_bold_movistar-web.woff") format("woff");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "Apercu Black";
      src: url("FONTS/apercu_black_movistar-web.woff2") format("woff2"),
           url("FONTS/apercu_black_movistar-web.woff") format("woff");
      font-weight: 800;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --brand: #ffba00;
      --ok: #7fe39a;
      --warn: #ffcc66;
      --err: #ff6b6b;
      --panel: #0d0d0d;
      --line: #141414;
      --sidebarW: 360px;
      --gap: 16px;
      --pad: 16px;
      --viewerPad: 20px;
      --swapDur: .28s;
      --swapEase: cubic-bezier(.25, .8, .25, 1);
      --handleW: 32px;
      --handleH: 28px;
      --padTop: 60px;
      --headerH: 52px;
      --edgePadHandle: 10px;
      --spaceHandleToViewer: 10px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow-x: hidden;
    }

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: "Apercu Regular", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
	  
    /* ===========================
       CAJA INICIAL (dropzone)
    ============================ */
    .landing {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px 48px;
      min-height: calc(100vh - (var(--headerH) + 40px));
    }
	  
    #drop-area {
      --drop-stroke: #fff;
      --drop-border: 12px;
      width: min(49vw, 294px);
      max-width: calc((100vw - 48px) * .7);
      max-height: calc((100vh - 220px) * .7);
      max-height: calc(100vh - 220px);
      aspect-ratio: 1 / 1;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      padding: clamp(16px, 5vw, 32px);
      background: #000;
      border: var(--drop-border) solid var(--drop-stroke);
      border-radius: 0;
      cursor: pointer;
      text-align: center;
      transition: border-color .2s ease, color .2s ease;
      font-size: clamp(12px, 2vw, 16px);
      position: relative;
    }

    #drop-area::after {
      content: "";
      position: absolute;
      width: calc(var(--drop-border) * 3);
      height: var(--drop-border);
      background: var(--drop-stroke);
      bottom: calc(var(--drop-border) * -1 + 40px);
      right: calc(var(--drop-border) * -1.5 - var(--drop-border) + 6px);
      transform: translateY(50%);
      transition: background-color .2s ease;
    }

    #drop-area:hover,
    #drop-area.highlight {
      --drop-stroke: var(--brand);
      border-color: var(--drop-stroke);
    }

    /* ===========================
       MODAL PRINCIPAL
    ============================ */
    .modal {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 28;
      display: none;
      overflow: hidden;
      flex-direction: column;
    }

    .modal.open {
      display: flex;
    }

    .close {
      position: absolute;
      top: 50%;
      right: 24px;
      transform: translateY(-50%);
      font-size: 32px;
      font-weight: 800;
      cursor: pointer;
      color: #fff;
      z-index: 25;
      font-family: "Apercu Black";
      user-select: none;
    }

    .close:hover {
      color: #ff4d4d;
    }

    /* ===========================
       LAYOUT MODAL
    ============================ */
    .modal-layout {
      position: relative;
      padding: var(--layoutPadTop, var(--padTop)) var(--pad) var(--pad);
      display: grid;
      grid-template-columns: var(--sidebarW) 1fr;
      gap: var(--gap);
      min-height: 0;
      height: auto;
      flex: 1;
      transition:
        grid-template-columns var(--swapDur) var(--swapEase),
        padding var(--swapDur) var(--swapEase),
        column-gap var(--swapDur) var(--swapEase);
    }

    .modal-layout.panel-right {
      grid-template-columns: 1fr var(--sidebarW);
    }

    .modal-layout.collapsed {
      grid-template-columns: 0 1fr;
    }

    .modal-layout.panel-right.collapsed {
      grid-template-columns: 1fr 0;
    }

    .modal-layout.collapsed,
    .modal-layout.panel-right.collapsed {
      column-gap: calc(var(--handleW) + var(--edgePadHandle) + var(--spaceHandleToViewer));
    }

    .swapping aside.sidebar,
    .swapping section.viewer {
      opacity: 0;
      transform: translateX(10px);
      transition: opacity .18s var(--swapEase), transform .18s var(--swapEase);
    }

    .panel-right.swapping aside.sidebar,
    .panel-right.swapping section.viewer {
      transform: translateX(-10px);
    }

    /* ===========================
       SIDEBAR
    ============================ */
    aside.sidebar {
      background: #0d0d0d;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .modal-layout.collapsed aside.sidebar,
    .modal-layout.panel-right.collapsed aside.sidebar {
      border: 0;
    }

    .sidebar-header {
      height: var(--headerH);
      background: #0a0a0a;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      gap: 6px;
    }

    .panel-right .sidebar-header {
      flex-direction: row-reverse;
    }

    .icon-btn {
      height: var(--handleH);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: transparent;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background .2s, border-color .2s;
    }

    #btnTogglePanel {
      width: var(--handleH);
    }

    #btnSwapSide {
      width: auto;
      padding: 0 6px;
    }

    #btnViewerBg {
      width: auto;
      padding: 0 6px;
    }

    #btnTogglePanel img,
    #btnSwapSide img,
    #btnViewerBg img {
      height: 18px;
      display: block;
      object-fit: contain;
      filter: invert(1);
      transition: transform .2s;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, .06);
      border-color: #1e1e1e;
    }

    .panel-right #btnTogglePanel img {
      transform: scaleX(-1);
    }

    .panel-right #btnSwapSide img {
      transform: scaleX(-1);
    }

    .btn-cluster {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .panel-right .btn-cluster {
      flex-direction: row-reverse;
    }

    .thumbs-scroll {
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px;
      position: relative;
      min-height: 0;
      scrollbar-width: none;
    }

    .thumbs-scroll::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }

    .thumbnails {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .thumbnail-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .thumbnail {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 6px;
      border: 2px solid #fff;
      cursor: pointer;
      transition: transform .2s, border .2s;
      position: relative;
    }

    .thumbnail.thumb-error {
      border-color: var(--err);
    }

    .thumbnail:hover {
      border-width: 3px;
      transform: scale(1.05);
    }

    .thumbnail.selected {
      border: 3px solid var(--brand) !important;
      cursor: default;
    }

    .thumbnail-wrapper.has-comment::after {
      content: "";
      position: absolute;
      left: 4px;
      top: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--brand);
      box-shadow:
        0 0 0 2px rgba(0, 0, 0, .55),
        0 2px 6px rgba(255, 186, 0, .55);
      z-index: 2;
    }

    .thumbnail-label {
      font-size: 10px;
      margin-top: 4px;
      max-width: 72px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #fff;
      text-align: center;
    }

    .thumbnail-label.error {
      color: var(--err);
      font-family: "Apercu Black";
    }

    /* ===========================
       TOOLTIP
    ============================ */
    #thumbTooltip {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      background: #0a0a0a;
      color: #fff;
      border: 1px solid #1e1e1e;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 11px;
      line-height: 1.25;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .35);
      max-width: 260px;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity .12s ease, transform .12s ease;
      white-space: pre-line;
    }

    #thumbTooltip.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* ===========================
       VIEWER
    ============================ */
    section.viewer {
      background: #0d0d0d;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    .viewer-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      background: #0a0a0a;
      text-align: center;
      color: #fff;
    }

    #filename {
      font-family: "Apercu Black";
      color: var(--brand);
      font-size: 20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .validations {
      font-family: "Apercu Bold";
      font-size: 14px;
    }

    .validations .ok {
      color: var(--ok);
    }

    .validations .err {
      color: var(--err);
    }

    .validations .warn {
      color: var(--warn);
    }

    .validations .sep {
      color: #fff;
      opacity: .9;
    }

    .viewer-inner {
      min-height: 0;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--viewerPad);
    }

#preview {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;         /* ← NUEVO: referencia para los absolutos */
}

    /* Modo especial AMAZON_BG: imagen pegada arriba */
    .viewer-inner.amazon-mode {
      align-items: flex-start;
    }

    .viewer-inner.amazon-mode #preview {
      align-items: flex-start;
    }


    #preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    .viewer-footer {
      border-top: 1px solid var(--line);
      background: #0a0a0a;
      padding: 12px 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      color: #fff;
    }

    /* Modo gris (viewer claro) */
    .viewer.viewer-light {
      background: #f4f4f4;
      border-color: #ddd;
    }

    .viewer.viewer-light .viewer-header,
    .viewer.viewer-light .viewer-footer {
      background: #f4f4f4;
      border-color: #ddd;
      color: #111;
    }

    .viewer.viewer-light .validations {
      color: #111;
    }

    .viewer.viewer-light .validations .sep {
      color: #333;
      opacity: .9;
    }

    .viewer.viewer-light #preview {
      background: #f4f4f4;
    }

    /* ===========================
       SWITCHES MOCKUP / TXT / FOCO
    ============================ */
    .switch-group {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
    }
    /* Switch de NIVEL: un poco separado del MOCKUP */
      #nivelSwitch {
      margin-left: 10px;
    }



    .switch {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      user-select: none;
      cursor: pointer;
      font-family: "Apercu Bold";
    }

    .switch input {
      display: none;
    }

    .switch .track {
      width: 46px;
      height: 24px;
      border-radius: 999px;
      background: #8a8a8a;
      position: relative;
      transition: background .18s ease;
    }

    .switch .knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      transition: left .18s ease;
    }

    .switch[data-on="true"] .track {
      background: #2ecc71;
    }

    .switch[data-on="true"] .knob {
      left: 24px;
    }

    /* LOGO: se oculta cuando el switch LOGO está OFF */
    /* BASE */
    #preview.mockup-off .v19-overlay.role-base {
      display: none !important;
    }

    /* ZONA DE SEGURIDAD */
    #preview.txt-off .v19-overlay.role-sib {
      display: none !important;
    }

    /* LOGO → depende de logo-off */
    #preview.logo-off .v19-overlay.role-logo {
      display: none !important;
    }



    /* ===========================
       HANDLE PLEGADO
    ============================ */
    .collapsed-handle {
      position: absolute;
      top: calc(var(--layoutPadTop, var(--padTop)) + (var(--headerH) - var(--handleH)) / 2);
      left: var(--edgePadHandle);
      z-index: 22;
      display: none;
      height: var(--handleH);
      width: var(--handleW);
      padding: 0 6px;
      border-radius: 8px;
      background: rgba(0, 0, 0, .6);
      border: 1px solid #1e1e1e;
      cursor: pointer;
      backdrop-filter: blur(2px);
    }

    .collapsed-handle img {
      height: 18px;
      display: block;
      filter: invert(1);
      transition: transform .2s;
    }

    .modal-layout.collapsed .collapsed-handle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .modal-layout.panel-right .collapsed-handle {
      left: auto;
      right: var(--edgePadHandle);
    }

    .modal-layout.panel-right .collapsed-handle img {
      transform: scaleX(-1);
    }

    /* ===========================
       COMENTARIOS
    ============================ */
    .comments-block {
      margin-top: 20px;
      border-top: 1px solid var(--line);
      background: #0a0a0a;
      padding: 12px 12px 10px;
    }

    .comments-title {
      font-family: "Apercu Black";
      letter-spacing: .3px;
      margin: 0;
      color: var(--brand);
    }

    .preset-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
    }

    .preset-toggle {
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      color: #fff;
      padding: 6px 14px;
      font-family: "Apercu Bold";
      font-size: 12px;
      letter-spacing: .4px;
      text-transform: uppercase;
      cursor: pointer;
      white-space: nowrap;
      transition: border-color .2s, background .2s;
      display: inline-flex;
      align-items: center;
      height: 30px;
    }

    .preset-toggle:hover {
      background: #353535;
      border-color: #454545;
    }

    .preset-toggle.is-active {
      border-color: var(--brand);
      background: #353535;
    }

    .preset-search {
      flex: 1;
      height: 30px;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      color: #fff;
      padding: 6px 12px;
      font-family: "Apercu Regular";
      font-size: 13px;
      font-weight: 400;
      outline: none;
    }

    .preset-search:focus {
      border-color: #505050;
    }

    .preset-search::placeholder {
      color: #aaa;
    }
    .preset-panel {
      margin-top: 6px;
      background: #0d0d0d;
      border: 1px solid #1e1e1e;
      border-radius: 10px;
      padding: 10px;
      display: none;
    }

    .preset-categories {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .preset-cat-btn {
      width: 100%;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      color: #fff;
      padding: 8px 12px;
      font-family: "Apercu Bold";
      font-size: 12px;
      letter-spacing: .3px;
      text-align: left;
      cursor: pointer;
      transition: border-color .2s, background .2s;
    }

    .preset-cat-btn:hover {
      background: #353535;
      border-color: #454545;
    }

    .preset-cat-btn.is-active {
      border-color: var(--brand);
      background: #353535;
    }

    .preset-item {
      width: 100%;
      background: #3a3a3a;
      border: 1px solid #4a4a4a;
      border-radius: 6px;
      color: #fff;
      padding: 8px 12px;
      font-family: "Apercu Regular";
      font-size: 12px;
      letter-spacing: .3px;
      text-align: left;
      cursor: pointer;
      transition: border-color .2s, background .2s;
    }

    .preset-item:hover {
      background: #454545;
      border-color: #555555;
    }

    .preset-list {
      margin-top: 10px;
      display: grid;
      gap: 6px;
    }

    .preset-feedback {
      min-height: 16px;
      font-size: 12px;
      opacity: .9;
      color: var(--brand);
      margin-top: 4px;
    }

    .comment-area {
      width: 100%;
      min-height: 120px;
      background: #0d0d0d;
      border: 1px solid #1e1e1e;
      border-radius: 10px;
      color: #fff;
      padding: 10px 12px;
      font-family: "Apercu Regular";
      font-size: 14px;
      resize: none;
      outline: none;
      margin-top: 8px;
    }

    .comment-area:focus {
      border-color: #2a2a2a;
    }

    .comments-actions {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      gap: 10px;
      margin-top: 20px;
      background: linear-gradient(
        180deg,
        rgba(10, 10, 10, 0),
        #0a0a0a 40%,
        #0a0a0a
      );
      padding-top: 10px;
      padding-bottom: 6px;
      border-top: 1px solid var(--line);
    }

    .btn {
      flex: 1;
      background: #111;
      border: 1px solid #1e1e1e;
      border-radius: 6px;
      color: #fff;
      padding: 8px 12px;
      font-family: "Apercu Bold";
      font-size: 12px;
      cursor: pointer;
      letter-spacing: .4px;
      text-transform: uppercase;
    }

    .btn:hover {
      background: #161616;
      border-color: #2a2a2a;
    }

    /* ===========================
       MODAL RESUMEN COMENTARIOS
    ============================ */
    #commentsModal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 30;
    }

    #commentsModal.open {
      display: block;
    }

    .cm-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, .55);
    }

    .cm-panel {
      position: fixed;
      z-index: 31;
      width: min(860px, calc(100vw - 2 * var(--pad)));
      max-height: 80vh;
      background: #0b0b0b;
      border: 1px solid #1a1a1a;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .cm-header {
      padding: 14px 18px;
      border-bottom: 1px solid #1a1a1a;
      background: #0f0f0f;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .cm-header .title {
      font-family: "Apercu Black";
      font-size: 16px;
      letter-spacing: .4px;
    }

    .cm-close {
      background: transparent;
      border: 0;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      line-height: 1;
    }

    .cm-body {
      padding: 16px;
      overflow: auto;
      font-size: 14px;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .cm-body .empty {
      opacity: .8;
      text-align: center;
      padding: 30px 0;
      font-style: italic;
    }

    .cm-item {
      margin-bottom: 18px;
    }

    .cm-item .fn {
      font-family: "Apercu Bold";
      color: var(--brand);
      margin-bottom: 4px;
    }

    .cm-item .cm-text {
      white-space: pre-wrap;
    }
    .amazon-logo-note {
      text-align: center;
      font-family: "Apercu Regular", sans-serif;
      font-size: 14px;
      color: #ccc;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    @media (max-width: 900px) {
      :root {
        --sidebarW: 300px;
      }
      .thumbnail {
        width: 64px;
        height: 64px;
      }
      .thumbnail-label {
        max-width: 64px;
        font-size: 9px;
      }
    }

    /* ===========================
       CABECERA SITE
    ============================ */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 24;
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 20px 0 20px;
      background: #000;
      margin-bottom: 12px;
    }

    .site-header img {
      max-width: 700px;
      height: auto;
      display: block;
    }

    .modal .modal-header-img {
      position: sticky;
      top: 0;
      left: 0;
      transform: none;
      z-index: 30;
      padding: 20px 0 4px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
	  
    .modal .modal-header-img {
      padding-right: 68px;
    }

    .modal .modal-header-img .close {
      right: 32px;
      top: 18px;
      transform: none;
      z-index: 40;
      pointer-events: auto;
    }

    .modal .modal-layout {
      --layoutPadTop: 4px;
      padding-top: var(--layoutPadTop);
    }

    .modal .modal-header-img img {
      max-width: 700px;
    }
  </style>
</head>

<body>

  <!-- ===========================
       CABECERA
  ============================ -->
  <header class="site-header">
    <img src="img/Cabecera_Negra.svg" alt="Cabecera" />
  </header>

  <!-- ===========================
       DROPZONE
  ============================ -->
  <main class="landing">
    <div id="drop-area">Arrastra aquí las imágenes o haz click para seleccionarlas</div>
  </main>
  <input type="file" id="fileElem" multiple accept="image/*" style="display:none" />
  <!-- ===========================
       MODAL PRINCIPAL
  ============================ -->
  <div id="myModal" class="modal" aria-hidden="true">
    <header class="site-header modal-header-img">
      <img src="img/Cabecera_Negra.svg" alt="Cabecera" />
      <span class="close" id="closeBtn" aria-label="Cerrar">×</span>
    </header>

    <div class="modal-layout" id="layout">
      <button
        type="button"
        id="collapsedHandle"
        class="collapsed-handle"
        title="Desplegar panel"
      >
        <img src="img/ic-back.svg" alt="Desplegar" />
      </button>

      <!-- ===========================
           SIDEBAR
      ============================ -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <button
            type="button"
            class="icon-btn"
            id="btnTogglePanel"
            title="Plegar panel"
          >
            <img src="img/ic-back.svg" alt="Plegar" />
          </button>

          <!-- Grupo fijo: Cambiar lado + cambiar fondo -->
          <div class="btn-cluster">
            <button
              type="button"
              class="icon-btn"
              id="btnSwapSide"
              title="Cambiar de lado el panel"
            >
              <img src="img/ic-side.svg" alt="Cambiar lado" />
            </button>

            <button
              type="button"
              class="icon-btn"
              id="btnViewerBg"
              title="Cambiar fondo del viewer"
            >
              <img src="img/ic-B-N.svg" alt="Fondo viewer" />
            </button>
          </div>
        </div>

        <div class="thumbs-scroll" id="scrollCol">
          <div class="thumbnails" id="thumbnails"></div>

          <!-- ===========================
               BLOQUE COMENTARIOS
          ============================ -->
          <div class="comments-block" id="commentsBlock">
            <div class="comments-title">COMENTARIOS</div>

              <div class="preset-row">
                <button
                  type="button"
                  id="presetToggleBtn"
                  class="preset-toggle"
                >
                  Predefinidos
                </button>

                <input
                  type="text"
                  id="presetSearch"
                  class="preset-search"
                  placeholder="Búsqueda"
                  aria-label="Búsqueda"
                />
              </div>

              <div id="presetPanel" class="preset-panel">
                <div id="presetCategories" class="preset-categories"></div>
                <div id="presetList" class="preset-list"></div>
              </div>

              <div
                id="presetFeedback"
                class="preset-feedback"
                aria-live="polite"
              ></div>

            <textarea
              id="commentArea"
              class="comment-area"
              placeholder="Escribe aquí tus comentarios…"
            ></textarea>

              <div class="comments-actions" id="commentsActions">
                <button class="btn" id="btnViewAll">Ver todos</button>
                <button class="btn" id="btnAttach" disabled>Adjuntos</button>
                <button class="btn" id="btnExport">Exportar</button>
              </div>


            <input
              type="file"
              id="attachInput"
              multiple
              accept="image/*"
              style="display:none;"
            />
          </div>
        </div>
      </aside>

      <!-- ===========================
           VIEWER
      ============================ -->
      <section class="viewer" id="viewer">
        <div class="viewer-header">
          <div id="filename">Selecciona un thumbnail</div>

          <div class="validations" id="validations">
            ✔ Nomenclatura
            <span class="sep"> | </span>
            ✔ Dimensiones
            <span class="sep"> | </span>
            ✔ Peso
          </div>
        </div>

          <div class="viewer-inner" id="viewerInner">
            <div id="preview"></div>
          </div>

<!-- Mensaje solo para AMAZON_LOGO -->
        <div id="amazonLogoNote" class="amazon-logo-note" style="display:none;">
          El contenido debe estar alienado a la esquina superior izquierda.
        </div>


                <div class="viewer-footer">

          <div id="switchGroup" class="switch-group">
            <!-- MOCKUP -->
            <label
              id="mockupSwitch"
              class="switch"
              role="switch"
              aria-checked="true"
              style="display:none"
            >
              <input type="checkbox" id="mockupToggle" checked />
              <span class="track"><span class="knob"></span></span>
              <span id="mockupText">MOCKUP</span>
            </label>

            <!-- NIVEL (solo FANART) -->
            <label
              id="nivelSwitch"
              class="switch"
              role="switch"
              aria-checked="false"
              style="display:none"
            >
              <span id="nivelLabelLeft">NIVEL 1</span>
              <input type="checkbox" id="nivelToggle" />
              <span class="track"><span class="knob"></span></span>
              <span id="nivelLabelRight">NIVEL 2</span>
            </label>

            <!-- TXT -->
            <label
              id="txtSwitch"
              class="switch"
              role="switch"
              aria-checked="true"
              style="display:none"
            >
              <input type="checkbox" id="txtToggle" checked />
              <span class="track"><span class="knob"></span></span>
              <span id="txtText">MARCAS DINÁMICAS</span>
            </label>

            <!-- LOGO (solo AMAZON_BG) -->
            <label
              id="logoSwitch"
              class="switch"
              role="switch"
              aria-checked="true"
              style="display:none"
            >
              <input type="checkbox" id="logoToggle" checked />
              <span class="track"><span class="knob"></span></span>
              <span id="logoText">LOGO</span>
            </label>


            <!-- FOCO -->
            <label
              id="focoSwitch"
              class="switch"
              role="switch"
              aria-checked="false"
              style="display:none"
            >
              <input type="checkbox" id="focoToggle" />
              <span class="track"><span class="knob"></span></span>
              <span>FOCO</span>
            </label>
          </div>
        </div>

      </section>

    </div>
  </div>

  <div id="thumbTooltip" role="tooltip" aria-hidden="true"></div>

  <!-- ===========================
       MODAL "RESUMEN DE COMENTARIOS"
  ============================ -->
  <div id="commentsModal" aria-hidden="true">
    <div class="cm-backdrop"></div>

    <div class="cm-panel" role="dialog" aria-modal="true" aria-labelledby="cmTitle">
      <div class="cm-header">
        <div class="title" id="cmTitle">RESUMEN DE COMENTARIOS</div>
        <button class="cm-close" id="cmClose" aria-label="Cerrar">×</button>
      </div>

      <div class="cm-body" id="cmBody"></div>
    </div>
  </div>

  <!-- ===========================
       LIBRERÍAS ZIP/TXT
  ============================ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- ===========================
       JS PRINCIPAL + VALIDACIONES + COMENTARIOS
  ============================ -->
  <script>
    /* ==========================================
       CONSTANTES GLOBALES
    ========================================== */
      const DL = {
      "APPLETV": "APPLE TV",
      "199": "199",
      "FANART_DESTACADO": "FANART",
      "FANART": "FANART",
      "FANART_MOVIL": "FANART MÓVIL",
      "IPLUS": "IPLUS",
      "MOD_DESTACADOS1": "MOD DES. 1",
      "MOD_DESTACADOS1_SIL": "MOD DES. 1 SIL",
      "MOD_DESTACADOS2": "MOD DES. 2",
      "MOD_DESTACADOS2_SIL": "MOD DES. 2 SIL",
      "MOD_DESTACADOS3": "MOD DES. 3",
      "MOD_DESTACADOS3_SIL": "MOD DES. 3 SIL",
      "MOD_DESTACADOS4": "MOD DES. 4",
      "MOD_DESTACADOS4_SIL": "MOD DES. 4 SIL",
      "MOD_N_SIL": "MOD N SIL",
      "MOD_N": "MOD N",
      "MUX4_FONDO": "MUX 4 FONDO",
      "MUX4_TXT": "MUX TXT",
      "SMARTPHONE_MUX_FONDO": "SPH. MUX FONDO",
      "SMARTPHONE_MUX_TXT": "SPH. MUX TXT",
      "TITULO_FICHA": "TITULO FICHA",
      "CARTEL_COM_H": "CARTEL COMUNICACIÓN HORIZONTAL",
      "CARTEL_COM_V": "CARTEL COMUNICACIÓN VERTICAL",
      "CARATULA_V": "CARATULA VERTICAL",
      "WEB": "WEB",
      "WOW": "WOW",
      "AMAZON_BG": "AMAZON",
      "AMAZON_LOGO": "AMAZON LOGO",
      "XIAOMI": "XIAOMI",
      "_PERFIL": "PERFIL",
      "_SONY": "SONY",
      "DESTACADO_DOBLE1": "DESTACADO DOBLE 1",
      "DESTACADO_DOBLE1_SIL": "DESTACADO DOBLE 1 SIL",
      "DESTACADO_DOBLE2": "DESTACADO DOBLE 2",
      "DESTACADO_DOBLE4_SIL": "DESTACADO DOBLE 4 SIL",
      "DESTACADO_DOBLE4": "DESTACADO DOBLE 4",
    };


    /* Reglas de dimensiones/peso */
      const RU = {
      "APPLETV": { w: 908, h: 512, mode: "exact", maxMB: 1 },
      "199": { w: 1920, h: 636, mode: "exact", maxMB: 4 },
      "FANART_DESTACADO": { w: 1920, h: 1080, mode: "exact", maxMB: 1.5 },
      "FANART": { w: 3840, h: 2160, mode: "exact", maxMB: 3 },
      "FANART_MOVIL": { w: 1440, h: 2986, mode: "exact", maxMB: 3 },
      "IPLUS": { w: 1280, h: 620, mode: "exact", maxMB: 0.15 },
      "MOD_DESTACADOS1": { w: 1636, h: 296, mode: "exact", maxMB: 1 },
      "MOD_DESTACADOS1_SIL": { w: 1920, h: 400, mode: "exact", maxMB: 1 },
      "MOD_DESTACADOS2": { w: 803, h: 296, mode: "exact", maxMB: 1 },
      "MOD_DESTACADOS2_SIL": { w: 863, h: 400, mode: "exact", maxMB: 1 },
      "MOD_DESTACADOS3": { w: 526, h: 296, mode: "exact", maxMB: 1 },
      "MOD_DESTACADOS3_SIL": { w: 584, h: 400, mode: "exact", maxMB: 1 },
      "MOD_N": {
        options: [
          { w: 386, h: 217 },
          { w: 385, h: 217 }
        ],
        mode: "list",
        maxMB: 0.6
      },
      "MOD_N_SIL": { w: 449, h: 300, mode: "exact", maxMB: 0.6 },
      "MUX4_FONDO": { w: 1920, h: 1080, mode: "exact", maxMB: 1.5 },
      "MUX4_TXT": { w: 784, h: 318, mode: "exact", maxMB: 0.6 },
      "SMARTPHONE_MUX_FONDO": { w: 1440, h: 2986, mode: "exact", maxMB: 1.5 },
      "SMARTPHONE_MUX_TXT": { w: 1440, h: 466, mode: "exact", maxMB: 0.6 },
      "TITULO_FICHA": { w: 724, h: 100, mode: "exact", maxMB: 0.6 },
      "CARTEL_COM_H": { w: 3840, h: 2160, mode: "exact", maxMB: 100 },
      "CARTEL_COM_V": { w: 2160, h: 3240, mode: "exact", maxMB: 100 },
      "CARATULA_V": { w: 1080, h: 1620, mode: "exact", maxMB: 5 },
      "CARATULA_V_TXT": { w: 1080, h: 1620, mode: "exact", maxMB: 5 },
      "CARATULA_H": { w: 1920, h: 1080, mode: "exact", maxMB: 5 },
      "CARATULA_H_TXT": { w: 1920, h: 1080, mode: "exact", maxMB: 5 },
      "WEB": { w: 2000, h: 465, mode: "exact", maxMB: 1 },
      "WOW": { w: 1280, h: 258, mode: "exact", maxMB: 0.25 },
      "XIAOMI": { w: 1280, h: 360, mode: "exact", maxMB: 10},
      "AMAZON_BG": { w: 1920, h: 720, mode: "exact", maxMB: 0.45 },
      "AMAZON_LOGO": { w: 640, h: 260, mode: "exact", maxMB: 0.45 },
      "_PERFIL": { w: 425, h: 479, mode: "exact", maxMB: 10 },
      "_SONY": { w: 204, h: 306, mode: "exact", maxMB: 10 },
      "DESTACADO_DOBLE1": { w: 1636, h: 548, mode: "exact", maxMB: 0.60 },
      "DESTACADO_DOBLE1_SIL": { w: 1636, h: 630, mode: "exact", maxMB: 1 },
      "DESTACADO_DOBLE2": { w: 803, h: 548, mode: "exact", maxMB: 1 },
      "DESTACADO_DOBLE2_SIL": { w: 803, h: 630, mode: "exact", maxMB: 1 },
      "DESTACADO_DOBLE4_SIL": {
        options: [
          { w: 386, h: 630 },
          { w: 385, h: 630 }
        ],
        mode: "list",
        maxMB: 1
      },
      "DESTACADO_DOBLE4": {
        options: [
          { w: 386, h: 548 },
          { w: 385, h: 548 }
        ],
        mode: "list",
        maxMB: 1
      },
		  
    };


    /* Títulos válidos */
    const AN = [
  { key: "MOD_DESTACADOS1_SIL", aliases: ["MOD_DESTACADOS1_SIL"] },
  { key: "MOD_DESTACADOS2_SIL", aliases: ["MOD_DESTACADOS2_SIL"] },
  { key: "MOD_DESTACADOS3_SIL", aliases: ["MOD_DESTACADOS3_SIL"] },
  { key: "MOD_DESTACADOS4_SIL", aliases: ["MOD_DESTACADOS4_SIL"] },
  { key: "MOD_N_SIL", aliases: ["MOD_N_SIL"] },

  // Variantes sin "S": MOD_DESTACADO1/2/3/4
  { key: "MOD_DESTACADOS1", aliases: ["MOD_DESTACADOS1", "MOD_DESTACADO1"] },
  { key: "MOD_DESTACADOS2", aliases: ["MOD_DESTACADOS2", "MOD_DESTACADO2"] },
  { key: "MOD_DESTACADOS3", aliases: ["MOD_DESTACADOS3", "MOD_DESTACADO3"] },
  { key: "MOD_DESTACADOS4", aliases: ["MOD_DESTACADOS4", "MOD_DESTACADO4"] },
  { key: "MOD_N", aliases: ["MOD_N"] },

  { key: "APPLETV", aliases: ["APPLETV"] },
  { key: "199", aliases: ["199"] },
  { key: "FANART_DESTACADO", aliases: ["FANART_DESTACADO"] },
  { key: "FANART", aliases: ["FANART"] },
  { key: "FANART_MOVIL", aliases: ["FANART_MOVIL"] },
  { key: "IPLUS", aliases: ["IPLUS"] },
  { key: "MUX4_FONDO", aliases: ["MUX4_FONDO"] },
  { key: "MUX4_TXT", aliases: ["MUX4_TXT"] },
  { key: "SMARTPHONE_MUX_FONDO", aliases: ["SMARTPHONE_MUX_FONDO"] },
  { key: "SMARTPHONE_MUX_TXT", aliases: ["SMARTPHONE_MUX_TXT"] },
  { key: "TITULO_FICHA", aliases: ["TITULO_FICHA"] },
  { key: "CARTEL_COM_H", aliases: ["CC_H"] },
  { key: "CARTEL_COM_V", aliases: ["CC_V"] },
  { key: "CARATULA_V", aliases: ["CARATULA_V"] },
  { key: "CARATULA_H", aliases: ["CARATULA_H"] },
  { key: "WEB", aliases: ["WEB"] },
  { key: "WOW", aliases: ["WOW"] },
  { key: "XIAOMI", aliases: ["XIAOMI"] },
  { key: "AMAZON_BG", aliases: ["AMAZON_BG"] },
  { key: "AMAZON_LOGO", aliases: ["AMAZON_LOGO"] },
  { key: "_PERFIL", aliases: ["_PERFIL"] },
  { key: "_SONY", aliases: ["_SONY", "SONY"] },
  { key: "DESTACADO_DOBLE1", aliases: ["DESTACADO_DOBLE1", "DESTACADO_DOBLE_1"] },
  { key: "DESTACADO_DOBLE1_SIL", aliases: ["DESTACADO_DOBLE1_SIL", "DESTACADO_DOBLE_SIL_1"] },
  { key: "DESTACADO_DOBLE2", aliases: ["DESTACADO_DOBLE2", "DESTACADO_DOBLE_2"] },
  { key: "DESTACADO_DOBLE2_SIL", aliases: ["DESTACADO_DOBLE2_SIL", "DESTACADO_DOBLE_SIL_2", "DESTACADO2_DOBLE_SIL"] },
  { key: "DESTACADO_DOBLE4_SIL", aliases: ["DESTACADO_DOBLE4_SIL", "DESTACADO_DOBLE_SIL_4"] },
  { key: "DESTACADO_DOBLE4", aliases: ["DESTACADO_DOBLE4", "DESTACADO_DOBLE_4"] }



];

    /* Transformación AN → búsqueda indexada */
    const AI = AN
      .flatMap(({ key: k, aliases: a }) => a.map(t => ({ k, t })))
      .sort((a, b) => b.t.length - a.t.length);

    /* Caracteres permitidos alrededor del patrón */
    const AB = new Set(["", "_", "-", " ", "."]);
 
    const endsWithSil = s => {
      const idx = s.lastIndexOf("_SIL");
      if (idx === -1) return false;

      const tail = s.slice(idx + 4);
      return /^(\.[A-Z0-9]+)?(?:[?#].*)?$/i.test(tail);
    };
    
    function checkName(n) {
  const u = String(n || "").toUpperCase();

  // 1) Caso especial *_SIL*
  if (u.includes("_SIL")) {
    if (!endsWithSil(u)) return null;

    const BASES = [
  { key: "MOD_DESTACADOS1_SIL", bases: ["MOD_DESTACADOS1", "MOD_DESTACADO1"] },
  { key: "MOD_DESTACADOS2_SIL", bases: ["MOD_DESTACADOS2", "MOD_DESTACADO2"] },
  { key: "MOD_DESTACADOS3_SIL", bases: ["MOD_DESTACADOS3", "MOD_DESTACADO3"] },
  { key: "MOD_DESTACADOS4_SIL", bases: ["MOD_DESTACADOS4", "MOD_DESTACADO4"] },
  { key: "DESTACADO_DOBLE1_SIL", bases: ["DESTACADO_DOBLE1", "DESTACADO_DOBLE_1"] },
  { key: "DESTACADO_DOBLE2_SIL", bases: ["DESTACADO_DOBLE2", "DESTACADO_DOBLE_2"] },
  { key: "DESTACADO_DOBLE4_SIL", bases: ["DESTACADO_DOBLE4", "DESTACADO_DOBLE_4"] },
  { key: "MOD_N_SIL", bases: ["MOD_N"] }
];



    for (const item of BASES) {
      for (const b of item.bases) {
        if (u.includes(b)) {
          // Si hay _SIL y el nombre base encaja, devolvemos la clave SIL
          return item.key;
        }
      }
    }

    // Tiene _SIL pero no corresponde a ningún MOD válido
    return null;
  }

  // 2) Lógica general: probamos TODOS los formatos salvo _PERFIL
  const dot = u.lastIndexOf(".");
  const b = dot > 0 ? u.slice(0, dot) : u;

  for (const { k, t } of AI) {
    if (k === "_PERFIL") continue; // _PERFIL se resuelve al final

    let i = -1;
    while ((i = b.indexOf(t, i + 1)) !== -1) {
      const prev = i === 0 ? "" : b[i - 1];
      const next = i + t.length >= b.length ? "" : b[i + t.length];

      // Evitamos cosas raras con signos +
      if (prev === "+" || next === "+") continue;

      // Solo aceptamos si está separado por _ - espacio . o inicio/fin
      if (AB.has(prev) && AB.has(next)) {
        return k; // devolvemos el formato encontrado
      }
    }
  }

  // 3) Fallback PERFIL:
  // solo si el nombre contiene exactamente "_PERFIL"
  // (así "EL_PERFIL_DEL_DEMONIO" NO pasa, pero "NOMBRE_PERFIL.png" SÍ)
  if (u.includes("_PERFIL")) {
    return "_PERFIL";
  }

  // 4) Sin coincidencias
  return null;
}


    const humanMB = b => (b / 1048576).toFixed(2);

    function checkDims(w, h, r) {
      const hasList = r && Array.isArray(r.options) && r.options.length;

      if (!r || (!hasList && (r.w == null || r.h == null)))
        return { status: "warn", msg: `(${w}×${h})` };

      if (hasList) {
        const match = r.options.find(o => w === o.w && h === o.h);
        const targetMsg = r.options.map(o => `${o.w}×${o.h}`).join(" / ");

        return {
          status: match ? "ok" : "err",
          msg: match ? targetMsg : `${w}×${h} (req. ${targetMsg})`
        };
      }

      const ok = w === r.w && h === r.h;
      return {
        status: ok ? "ok" : "err",
        msg: ok ? `${r.w}×${r.h}` : `${w}×${h} (req. ${r.w}×${r.h})`
      };
    }

    function checkWeight(b, r) {
      if (!r || r.maxMB == null)
        return { status: "warn", msg: `${humanMB(b)} MB` };

      const ok = b <= r.maxMB * 1048576;
      return {
        status: ok ? "ok" : "err",
        msg: ok
          ? `Max: ${r.maxMB} MB (${humanMB(b)} MB)`
          : `${humanMB(b)} MB (> ${r.maxMB} MB)`
      };
    }
  </script>

  <!-- ===========================
       JS APLICACIÓN COMPLETA
  ============================ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      /* ==========================================
         RESET LOCALSTORAGE
      ========================================== */
      localStorage.removeItem("v15_comments");
      localStorage.removeItem("v15_comments_injected");

      const ATTACH = Object.create(null);

      const qs = id => document.getElementById(id);

      const dropArea = qs("drop-area");
      const fileInput = qs("fileElem");
      const modal = qs("myModal");
      const layout = qs("layout");
      const sidebar = qs("sidebar");
      const viewer = qs("viewer");
      const viewerInner = qs("viewerInner");

      const thumbnailsDiv = qs("thumbnails");
      const filenameDisplay = qs("filename");
      const preview = qs("preview");
      const closeBtn = qs("closeBtn");
      const validationsEl = qs("validations");

      const mockupSwitch = qs("mockupSwitch");
      const mockupToggle = qs("mockupToggle");

      const txtSwitch = qs("txtSwitch");
      const txtToggle = qs("txtToggle");

const logoSwitch = qs("logoSwitch");
const logoToggle = qs("logoToggle");

      const focoSwitch = qs("focoSwitch");
      const focoToggle = qs("focoToggle");

      	// FANART – switch NIVEL
      const nivelSwitch = qs("nivelSwitch");
      const nivelToggle = qs("nivelToggle");

        const commentArea = qs("commentArea");
        const presetToggleBtn = qs("presetToggleBtn");
        const presetSearch = qs("presetSearch");
        const presetPanel = qs("presetPanel");
        const presetCategories = qs("presetCategories");
        const presetList = qs("presetList");
        const presetFeedback = qs("presetFeedback");

      const btnViewAll = qs("btnViewAll");
      const btnExport = qs("btnExport");
      const btnAttach = qs("btnAttach");
      const attachInput = qs("attachInput");

      const scrollCol = qs("scrollCol");
      const commentsBlock = qs("commentsBlock");
      const actionsBar = qs("commentsActions");

      const tooltipEl = qs("thumbTooltip");
      const btnTogglePanel = qs("btnTogglePanel");
      const collapsedHandle = qs("collapsedHandle");
      const btnSwapSide = qs("btnSwapSide");
      const btnViewerBg = qs("btnViewerBg");

            const mockupText = qs("mockupText");
      const txtText = qs("txtText");
      const amazonLogoNote = qs("amazonLogoNote");


      window.focoOn = false;
      window.LOADED_ITEMS = [];

      let totalToLoad = 0;
      // FANART – nivel actual (1 o 2)
      window.fanartNivel = 1;
      let validatedCount = 0;
      let firstThumbEl = null;
      let firstThumbFile = null;
	  let currentKey = "";

        /* ==========================================
           PRESETS
        ========================================== */
        const PRESET_CATEGORIES = {
          ADJUNTOS: [
            "Os adjuntamos un ejemplo.",
            "Os sugerimos que lo hagáis como en el ejemplo que os mandamos."
          ],
          "TAMAÑO/PESO": [
            "Supera el peso máximo.",
            "Las dimensiones de la adaptación no son correctas."
          ],
          DISEÑO: [
            "Está fuera de los márgenes de seguridad.",
            "Falta la etiqueta de publicidad.",
            "Falta información.",
            "No sigue la misma coherencia visual que el resto de adaptaciones."
          ],
          TEXTOS: [
            "El texto no cumple con el tamaño mínimo para que sea legible.",
            "El texto no es legible.",
            "Mux4_Fondo no puede llevar texto.",
            "SmartphoneMux_Fondo no puede llevar texto.",
            "Hay demasiada información.",
            "El orden de los textos es diferente al resto de adaptaciones.",
            "El texto se ve pixelado.",
            "Poner el texto en una líneas.",
            "Poner el texto en dos líneas.",
            "Poner el texto en tres líneas.",
            "Cambiar el color del texto.",
            "Añadir un degradado para que el texto se lea bien."
          ],
          NOMENCLATURAS: [
            "La adaptación no está bien nombrada."
          ],
          IMAGEN: [
            "La imagen se ve pixelada.",
            "La imagen no tienen suficiente calidad.",
            "La sombra es demasiado fuerte.",
            "La imagen está cortada.",
            "Mejorar el recorte de la imagen.",
            "Rellenar la imagen con imagen generativa.",
            "Hay un filete en el lado derecho.",
            "Hay un filete en el lado izquierdo.",
            "Hay un filete en el lado arriba.",
            "Hay un filete en el lado abajo."
          ]
        };

        const PRESET_ENTRIES = Object.entries(PRESET_CATEGORIES).flatMap(
          ([cat, items]) => items.map(text => ({ cat, text }))
        );

        let isPresetPanelOpen = false;
        let activeCategory = "";

      /* ==========================================
         LOCALSTORAGE HELPERS
      ========================================== */
      const LS_KEY = "v15_comments";
      const LS_INJECT = "v15_comments_injected";

      const getMap = k => {
        try {
          return JSON.parse(localStorage.getItem(k) || "{}");
        } catch {
          return {};
        }
      };

      const setMap = (k, m) => localStorage.setItem(k, JSON.stringify(m));

      const commentsMap = () => getMap(LS_KEY);
      const injectedMap = () => getMap(LS_INJECT);

      function getCurrentFileName() {
        const img = window.__v19_getMainPreviewImg?.();
        return img?.alt || filenameDisplay.textContent || "";
      }

      function loadCommentsFor(file) {
        const map = commentsMap();
        return map[file] || "";
      }

      function saveCommentsFor(file, text) {
        const map = commentsMap();
        map[file] = text;
        setMap(LS_KEY, map);

        const wrap = [...thumbnailsDiv.querySelectorAll(".thumbnail")]
          .find(el => el.alt === file)?.parentElement;

        if (wrap) wrap.classList.toggle("has-comment", !!(text || "").trim());
      }

      function markInjected(file) {
        const m = injectedMap();
        m[file] = true;
        setMap(LS_INJECT, m);
      }

      function wasInjected(file) {
        const m = injectedMap();
        return !!m[file];
      }

      /* ==========================================
         INYECTAR LÍNEAS DE ERROR AUTOMÁTICAMENTE
      ========================================== */
      function injectValidationLinesIfNeeded(file, res) {
        if (!file || !res || wasInjected(file)) return;

        const lines = [];
        if (!res.nameOk)
          lines.push("- Nomenclatura incorrecta.");
        if (res.dimsInfo?.status === "err")
          lines.push(`- Dimensiones incorrectas (${res.dimsInfo.msg}).`);
        if (res.weightInfo?.status === "err")
          lines.push(`- Peso excesivo (${res.weightInfo.msg}).`);

        if (!lines.length) return;

        const existing = loadCommentsFor(file);
        const final = existing
          ? existing.trimEnd() + "\n" + lines.join("\n")
          : lines.join("\n");

        saveCommentsFor(file, final);
        commentArea.value = final;

        markInjected(file);
      }

      /* ==========================================
         ICONO DE PUNTO AMARILLO EN THUMBS
      ========================================== */
      function applyHasCommentBadges() {
        const map = commentsMap();
        thumbnailsDiv.querySelectorAll(".thumbnail").forEach(t => {
          const wrap = t.parentElement;
          const tx = map[t.alt || ""] || "";
          wrap.classList.toggle("has-comment", !!tx.trim());
        });
      }

      /* ==========================================
         MOSTRAR ESTADO DE VALIDACIONES
      ========================================== */
      function renderValidations(r) {
        if (!r) return;

        validationsEl.innerHTML =
          `<span class="${r.nameOk ? "ok" : "err"}">
             ${r.nameOk ? "✔" : "✖"} Nomenclatura
           </span>
           <span class="sep"> | </span>
           <span class="${
             r.dimsInfo?.status === "ok"
               ? "ok"
               : r.dimsInfo?.status === "err"
               ? "err"
               : "warn"
           }">
              ${r.dimsInfo?.status === "ok" ? "✔" : "●"} Dimensiones: ${
            r.dimsInfo?.msg
          }
           </span>
           <span class="sep"> | </span>
           <span class="${
             r.weightInfo?.status === "ok"
               ? "ok"
               : r.weightInfo?.status === "err"
               ? "err"
               : "warn"
           }">
              ${r.weightInfo?.status === "ok" ? "✔" : "●"} Peso: ${
            r.weightInfo?.msg
          }
           </span>`;
      }

      /* ==========================================
         SWITCHES
      ========================================== */
      const setSwitchVisible = (el, v) =>
        (el.style.display = v ? "inline-flex" : "none");

      function setSwitchState(el, input, on) {
        input.checked = !!on;
        el.dataset.on = on ? "true" : "false";
        el.setAttribute("aria-checked", on ? "true" : "false");
      }

            const setOverlayMockupForced = on => {
  const keyUp = (currentKey || "").toUpperCase();
  const isCaratula = keyUp === "CARATULA_V" || keyUp === "CARATULA_H";

  if (isCaratula) {
    // En CARATULA_V / CARATULA_H el botón IZQUIERDO (ZONAS DE SEGURIDAD)
    // controla el overlay del CHECKER (role-sib → txt-off)
    preview.classList.toggle("txt-off", !on);
  } else {
    // Resto de formatos: comportamiento normal (overlay base)
    preview.classList.toggle("mockup-off", !on);
  }
};

      const setOverlayTxtForced = on => {
  const keyUp = (currentKey || "").toUpperCase();
  const isCaratula = keyUp === "CARATULA_V" || keyUp === "CARATULA_H";

  if (isCaratula) {
    // En CARATULA_V / CARATULA_H el botón DERECHO (MARCAS DINÁMICAS)
    // controla el overlay de MARCAS (role-base → mockup-off)
    preview.classList.toggle("mockup-off", !on);
  } else {
    // Resto de formatos: comportamiento normal (overlay sibling)
    preview.classList.toggle("txt-off", !on);
  }
};



      function setMockupState(on) {
        setSwitchState(mockupSwitch, mockupToggle, on);
        setOverlayMockupForced(on);
      }

      function setTxtState(on) {
        setSwitchState(txtSwitch, txtToggle, on);
        setOverlayTxtForced(on);
      }

function setLogoState(on) {
  setSwitchState(logoSwitch, logoToggle, on);
  preview.classList.toggle("logo-off", !on);
}


      // FANART – cambiar nivel 1/2
      function setNivelState(on) {
        // on = true  → NIVEL 2
        // on = false → NIVEL 1
        if (!nivelSwitch || !nivelToggle) return;

        // Actualizamos el estado visual del switch
        setSwitchState(nivelSwitch, nivelToggle, on);

        // Guardamos el nivel elegido
        window.fanartNivel = on ? 2 : 1;

        // Pedir refresco de overlays (overlay FANART)
        document.dispatchEvent(new CustomEvent("v19-refresh"));
      }


      function getOverlayBase() {
        return document.querySelector(
          "#preview .v19-overlay.role-base"
        );
      }

      function refreshSwitchVisibility() {
        const ov = getOverlayBase();
        const h = !!(ov && ov.getAttribute("src"));
        setSwitchVisible(mockupSwitch, h);
      }

       /* Cambio dinámico MOCKUP ↔ ZONAS DE SEGURIDAD */
      function updateMockupLabel(key) {
        const ku = (key || "").toUpperCase();
		  
        if (ku === "MOD_N" || ku === "MOD_N_SIL") {
          mockupText.textContent = "ZONA DE SEGURIDAD";
          return;
        }

        // Formatos que SÍ deben llamarse MOCKUP
        const mockupFormats = new Set([
          "FANART_DESTACADO",
          "FANART",
          "FANART_MOVIL",
          "MUX4_FONDO",
          "SMARTPHONE_MUX_FONDO",
          "AMAZON_BG"
        ]);

        mockupText.textContent = mockupFormats.has(ku)
          ? "MOCKUP"
          : "ZONAS DE SEGURIDAD";
      }

	  
      function updateTxtLabel(key) {
        const k = (key || "").toUpperCase();

        // MUX4_FONDO / SMARTPHONE_MUX_FONDO → TXT
        if (k === "MUX4_FONDO" || k === "SMARTPHONE_MUX_FONDO") {
          txtText.textContent = "TXT";
          return;
        }

        // AMAZON_BG / AMAZON_LOGO → ZONA DE SEGURIDAD
        if (k === "AMAZON_BG" || k === "AMAZON_LOGO") {
          txtText.textContent = "ZONA DE SEGURIDAD";
          return;
        }

        // _SONY → ZONA DE SEGURIDAD
        if (k === "_SONY") {
          txtText.textContent = "ZONA DE SEGURIDAD";
          return;
        }


        // DESTACADO_DOBLE1 → ZONA DE SEGURIDAD
        if (
  k === "DESTACADO_DOBLE1" ||
  k === "DESTACADO_DOBLE1_SIL" ||
  k === "DESTACADO_DOBLE2" ||
  k === "DESTACADO_DOBLE2_SIL" ||
  k === "DESTACADO_DOBLE4" ||
  k === "DESTACADO_DOBLE4_SIL"
) {
    txtText.textContent = "ZONA DE SEGURIDAD";
    return;
}




        // Resto de formatos → MARCAS DINÁMICAS
        txtText.textContent = "MARCAS DINÁMICAS";
      }



      /* ==========================================
         ABRIR / CERRAR MODAL
      ========================================== */
      function openModal() {
        modal.classList.add("open");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");
        resetModalState();
      }

      function resetModalState() {
        thumbnailsDiv.innerHTML = "";
        preview.innerHTML = "";

        filenameDisplay.textContent = "Selecciona un thumbnail";
        validationsEl.innerHTML =
          `✔ Nomenclatura <span class="sep"> | </span> ✔ Dimensiones <span class="sep"> | </span> ✔ Peso`;

        layout.classList.remove("collapsed");
        fileInput.value = "";

        window.LOADED_ITEMS = [];

        setMockupState(true);
        setSwitchVisible(mockupSwitch, false);

        setTxtState(true);
        setSwitchVisible(txtSwitch, false);
setLogoState(true);
setSwitchVisible(logoSwitch, false);
preview.classList.remove("logo-off");


        // FANART – resetear NIVEL a 1 y ocultar el switch
        setNivelState(false);
        setSwitchVisible(nivelSwitch, false);

        setSwitchState(focoSwitch, focoToggle, false);
        window.focoOn = false;
        window.fanartNivel = 1;
	currentKey = "";
        setSwitchVisible(focoSwitch, false);

        commentArea.value = "";
        applyHasCommentBadges();
        btnAttach.disabled = true;

        viewer.classList.remove("viewer-light");
        mockupText.textContent = "MOCKUP";

        if (viewerInner) {
          viewerInner.classList.remove("amazon-mode");
        }

 if (amazonLogoNote) {
          amazonLogoNote.style.display = "none";
        }

        requestAnimationFrame(recalcCommentsLayout);
      }

      /* ==========================================
         CAMBIO DE LADO DEL PANEL
      ========================================== */
      function applySide(s) {
        layout.classList.add("swapping");

        const f = document.createDocumentFragment();

        if (s === "right") {
          layout.classList.add("panel-right");
          f.appendChild(viewer);
          f.appendChild(sidebar);
        } else {
          layout.classList.remove("panel-right");
          f.appendChild(sidebar);
          f.appendChild(viewer);
        }

        layout.appendChild(f);
        localStorage.setItem("panelSide", s);

        setTimeout(() => {
          layout.classList.remove("swapping");
          recalcCommentsLayout();
        }, 120);
      }

      function toggleSide() {
        applySide(layout.classList.contains("panel-right") ? "left" : "right");
      }

      function initSideFromStorage() {
        applySide(localStorage.getItem("panelSide") || "left");
      }

      /* ==========================================
         TOOLTIP DE ERRORES
      ========================================== */
      function buildErrorReason(n, r) {
        const m = [];

        if (!r.nameOk)
          m.push(`Nomenclatura: no válida para “${n}”.`);
        if (r.dimsInfo?.status === "err")
          m.push(`Dimensiones: ${r.dimsInfo.msg}.`);
        if (r.weightInfo?.status === "err")
          m.push(`Peso: ${r.weightInfo.msg}.`);

        return m.join("\n");
      }

      function showTooltip(x, y, t) {
        tooltipEl.textContent = t;
        tooltipEl.style.left = Math.round(x + 12) + "px";
        tooltipEl.style.top = Math.round(y + 12) + "px";
        tooltipEl.classList.add("show");
        tooltipEl.setAttribute("aria-hidden", "false");
      }

      function hideTooltip() {
        tooltipEl.classList.remove("show");
        tooltipEl.setAttribute("aria-hidden", "true");
      }

      /* ==========================================
         DRAG & DROP
      ========================================== */
      ["dragenter", "dragover", "dragleave", "drop"].forEach(ev => {
        dropArea.addEventListener(ev, e => {
          e.preventDefault();
          e.stopPropagation();

          if (e.type === "dragover" && e.dataTransfer) {
            e.dataTransfer.dropEffect = "copy";
          }
        });
      });

      ["dragenter", "dragover"].forEach(ev => {
        dropArea.addEventListener(ev, () => dropArea.classList.add("highlight"));
      });

      ["dragleave", "drop"].forEach(ev => {
        dropArea.addEventListener(ev, () => dropArea.classList.remove("highlight"));
      });

      dropArea.addEventListener("drop", e => {
        if (e.dataTransfer) handleFiles(e.dataTransfer.files);
      });

      dropArea.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", () => handleFiles(fileInput.files));

      closeBtn.addEventListener("click", closeModal);

      window.addEventListener("keydown", e => {
        if (e.key === "Escape" && modal.classList.contains("open"))
          closeModal();
      });

      btnTogglePanel.addEventListener("click", () =>
        layout.classList.toggle("collapsed")
      );

      collapsedHandle?.addEventListener("click", () =>
        layout.classList.remove("collapsed")
      );

      btnSwapSide.addEventListener("click", toggleSide);

      btnViewerBg.addEventListener("click", () =>
        viewer.classList.toggle("viewer-light")
      );

      /* ==========================================
         SWITCHES MANUALES
      ========================================== */
      mockupSwitch.addEventListener("click", () =>
        setMockupState(!mockupToggle.checked)
      );

      mockupToggle.addEventListener("change", e =>
        setMockupState(e.target.checked)
      );

      txtSwitch.addEventListener("click", () =>
        setTxtState(!txtToggle.checked)
      );

logoSwitch.addEventListener("click", () =>
  setLogoState(!logoToggle.checked)
);

logoToggle.addEventListener("change", e =>
  setLogoState(e.target.checked)
);


      txtToggle.addEventListener("change", e =>
        setTxtState(e.target.checked)
      );

      // FANART – cambio de NIVEL 1 / 2
      nivelSwitch.addEventListener("click", () =>
        setNivelState(!nivelToggle.checked)
      );

      nivelToggle.addEventListener("change", e =>
        setNivelState(e.target.checked)
      );

      focoSwitch.addEventListener("click", () => {
        const on = !focoToggle.checked;
        setSwitchState(focoSwitch, focoToggle, on);
        window.focoOn = on;
        document.dispatchEvent(new CustomEvent("v19-refresh"));
      });

      focoToggle.addEventListener("change", e => {
        const on = !!e.target.checked;
        setSwitchState(focoSwitch, focoToggle, on);
        window.focoOn = on;
        document.dispatchEvent(new CustomEvent("v19-refresh"));
      });

      new MutationObserver(() => refreshSwitchVisibility()).observe(
        document.getElementById("preview"),
        {
          subtree: true,
          attributes: true,
          childList: true,
          attributeFilter: ["src", "style", "class"]
        }
      );

      initSideFromStorage();

const shouldShowTxtSwitch = k => {
  const ku = (k || "").toUpperCase();
  return (
    ku === "MUX4_FONDO" ||
    ku === "SMARTPHONE_MUX_FONDO" ||
    ku === "CARATULA_V" ||
    ku === "CARATULA_H" ||
    ku === "AMAZON_BG" ||
    ku === "AMAZON_LOGO" ||
    ku === "_SONY" ||
    ku === "DESTACADO_DOBLE1" ||
    ku === "DESTACADO_DOBLE1_SIL" ||
    ku === "DESTACADO_DOBLE2" ||
    ku === "DESTACADO_DOBLE2_SIL" ||
    ku === "DESTACADO_DOBLE4" ||
    ku === "DESTACADO_DOBLE4_SIL"
  );
};






      const shouldShowFocoSwitch = k => k === "MUX4_FONDO";

      // FANART → único formato que enseña el switch NIVEL
      const shouldShowNivelSwitch = k => {
        const ku = (k || "").toUpperCase();
        return ku === "FANART";
      };

const shouldShowLogoSwitch = k =>
  (k || "").toUpperCase() === "AMAZON_BG";


      /* ==========================================
         VALIDAR METADATOS
      ========================================== */
      function validateFileMeta(file, dataUrl, cb) {
        const matched = checkName(file.name);
        const rule = matched ? RU[matched] : null;
        const nameOk = !!matched;

        const probe = new Image();
        probe.onload = () => {
          const dimsInfo = checkDims(
            probe.naturalWidth,
            probe.naturalHeight,
            rule
          );
          const weightInfo = checkWeight(file.size, rule);
          const hasError =
            !nameOk ||
            dimsInfo.status === "err" ||
            weightInfo.status === "err";

          cb({
            matched,
            nameOk,
            dimsInfo,
            weightInfo,
            hasError
          });
        };

        probe.src = dataUrl;
      }

      /* ==========================================
         SELECCIONAR THUMBNAIL
      ========================================== */
      function selectThumb(timg, res, dataUrl, file) {
        document
          .querySelectorAll(".thumbnail")
          .forEach(el => el.classList.remove("selected"));

        timg.classList.add("selected");

        const key =
          (res && res.matched) ||
          timg._earlyKey ||
          checkName(file?.name || "");
		  currentKey = key || "";
// AMAZON_BG: modo especial de alineación (imagen pegada arriba)
        const isAmazon = (key || "").toUpperCase() === "AMAZON_BG";
        if (viewerInner) {
          viewerInner.classList.toggle("amazon-mode", isAmazon);
        }

        filenameDisplay.textContent =
          file?.name || key || "";

// ➜ Mensaje solo en AMAZON_LOGO
if (amazonLogoNote) {
  if ((key || "").toUpperCase() === "AMAZON_LOGO") {
    amazonLogoNote.style.display = "block";
  } else {
    amazonLogoNote.style.display = "none";
  }
}

        preview.innerHTML = "";
        const big = new Image();
        big.src = dataUrl;
        big.alt = file?.name || "";
        preview.appendChild(big);

        if (res) renderValidations(res);

setMockupState(true);

// 1) Visibilidad normal del TXT según formato
setSwitchVisible(txtSwitch, shouldShowTxtSwitch(key || ""));

// 2) Seguridad extra: si es AMAZON_BG, forzamos que se vea sí o sí
if ((key || "").toUpperCase() === "AMAZON_BG") {
  txtSwitch.style.display = "inline-flex";
}

setTxtState(true);

        setSwitchVisible(focoSwitch, shouldShowFocoSwitch(key || ""));
        setSwitchState(focoSwitch, focoToggle, false);
        window.focoOn = false;

        updateMockupLabel(key || "");
	updateTxtLabel(key || "");

// LOGO solo AMAZON_BG
if (shouldShowLogoSwitch(key || "")) {
  setSwitchVisible(logoSwitch, true);
  setLogoState(true);
} else {
  setSwitchVisible(logoSwitch, false);
  preview.classList.remove("logo-off");
}


        /* ===========================
           FANART – Gestión del switch NIVEL
        ============================ */

        if ((key || "").toUpperCase() === "FANART") {
          // Mostrar el switch
          setSwitchVisible(nivelSwitch, true);

          // Resetear a NIVEL 1
          setNivelState(false);   // ← nivelToggle.checked = false → NIVEL 1

        } else {
          // Ocultar switch
          setSwitchVisible(nivelSwitch, false);

          // Reset interno siempre a NIVEL 1
          window.fanartNivel = 1;
        }

        setTimeout(refreshSwitchVisibility, 0);
        document.dispatchEvent(new CustomEvent("v19-refresh"));

        const fname = file?.name || "";
        const existing = loadCommentsFor(fname);
        commentArea.value = existing;

        if (!existing) injectValidationLinesIfNeeded(fname, res);

        applyHasCommentBadges();
        btnAttach.disabled = !fname;

        recalcCommentsLayout();
      }

      /* ==========================================
         CARGAR ARCHIVOS
      ========================================== */
      function handleFiles(files) {
        const imgs = Array.from(files || [])
          .filter(f => f.type && f.type.startsWith("image/"))
          .sort((a, b) =>
            a.name.localeCompare(b.name, "es", { sensitivity: "base" })
          );

        if (!imgs.length) return;
        resetModalState();

        totalToLoad = imgs.length;
        validatedCount = 0;
        firstThumbEl = null;
        firstThumbFile = null;

        imgs.forEach(file => {
          const wrap = document.createElement("div");
          wrap.className = "thumbnail-wrapper";

          const timg = document.createElement("img");
          timg.className = "thumbnail";
          timg.alt = file.name;

          const lab = document.createElement("div");
          lab.className = "thumbnail-label";
          lab.textContent = "…";

          wrap.addEventListener("mouseenter", ev => {
            const r = timg._validation;
            if (r && r.hasError) {
              const txt = buildErrorReason(file.name, r);
              if (txt) showTooltip(ev.clientX, ev.clientY, txt);
            }
          });

          wrap.addEventListener("mousemove", ev => {
            if (tooltipEl.classList.contains("show")) {
              tooltipEl.style.left = Math.round(ev.clientX + 12) + "px";
              tooltipEl.style.top = Math.round(ev.clientY + 12) + "px";
            }
          });

          wrap.addEventListener("mouseleave", hideTooltip);

          timg.addEventListener("click", () => {
            const r = timg._validation;
            const d = timg.src;
            selectThumb(timg, r, d, file);
          });

          wrap.appendChild(timg);
          wrap.appendChild(lab);
          thumbnailsDiv.appendChild(wrap);

          if (!firstThumbEl) {
            firstThumbEl = timg;
            firstThumbFile = file;
          }

          const reader = new FileReader();
          reader.onload = e => {
            const d = e.target.result;
            timg.src = d;

            window.LOADED_ITEMS.push({
              name: file.name,
              src: d
            });

            const early = checkName(file.name);
            timg._earlyKey = early;

            lab.textContent = DL[early] || early || file.name;

            validateFileMeta(file, d, res => {
              timg._validation = res;

              if (res.hasError) {
                lab.textContent = "¡ERROR!";
                lab.classList.add("error");
                timg.classList.add("thumb-error");
              } else {
                lab.textContent =
                  DL[res.matched] || res.matched || file.name;

                lab.classList.remove("error");
                timg.classList.remove("thumb-error");
              }

              if (timg.classList.contains("selected"))
                renderValidations(res);

              validatedCount++;

              /* Selección automática del primero */
              if (validatedCount === totalToLoad) {
                if (
                  firstThumbEl &&
                  !document.querySelector(".thumbnail.selected")
                ) {
                  selectThumb(
                    firstThumbEl,
                    firstThumbEl._validation || null,
                    firstThumbEl.src,
                    firstThumbFile
                  );
                }
                recalcCommentsLayout();
              }
            });
          };

          reader.readAsDataURL(file);
        });

        openModal();
      }

      /* ==========================================
         RE-CALCULO ALTURA CAMPO COMENTARIOS
      ========================================== */
      function recalcCommentsLayout() {
        commentsBlock.style.marginTop = thumbnailsDiv.children.length
          ? "20px"
          : "20px";

        const scrollRect = scrollCol.getBoundingClientRect();
        const areaRect = commentArea.getBoundingClientRect();
        const actionsH = actionsBar.offsetHeight || 0;

        const topGap = areaRect.top - scrollRect.top;

        let available =
          scrollRect.height - topGap - actionsH - 20;

        available = Math.max(120, Math.floor(available));
        commentArea.style.height = available + "px";
      }

      scrollCol.addEventListener("scroll", recalcCommentsLayout, {
        passive: true
      });

      window.addEventListener("resize", recalcCommentsLayout);

      new ResizeObserver(recalcCommentsLayout).observe(scrollCol);
      new ResizeObserver(recalcCommentsLayout).observe(commentsBlock);

      /* ==========================================
         ESCRIBIR COMENTARIOS
      ========================================== */
      commentArea.addEventListener("input", () => {
        const fname = getCurrentFileName();
        if (!fname) return;
        saveCommentsFor(fname, commentArea.value);
      });

        /* ==========================================
           PRESETS
        ========================================== */
        let fbTimer = null;

        function showPresetFeedback(msg) {
          presetFeedback.textContent = msg || "";
          clearTimeout(fbTimer);

          if (msg) {
            fbTimer = setTimeout(() => {
              presetFeedback.textContent = "";
            }, 2000);
          }
        }
        function lineAlreadyExists(text, line) {
          const lines = (text || "")
            .split(/\r?\n/)
            .map(s => s.trim())
            .filter(Boolean);
          return lines.includes(line.trim());
        }

        function setPresetPanelVisibility(show) {
          isPresetPanelOpen = show;
          presetPanel.style.display = show ? "block" : "none";
          presetToggleBtn.classList.toggle("is-active", show);
          recalcCommentsLayout();
        }

        function resetPresetPanel() {
          // Ocultar panel
          isPresetPanelOpen = false;
          presetPanel.style.display = "none";
          presetToggleBtn.classList.remove("is-active");
          
          // Resetear categoría activa
          activeCategory = "";
          
          // Limpiar buscador
          presetSearch.value = "";
          
          // Limpiar lista de mensajes
          presetList.innerHTML = "";
          
          // Re-renderizar categorías sin ninguna activa
          renderPresetCategories();
          
          recalcCommentsLayout();
        }

        function renderPresetCategories() {
          presetCategories.innerHTML = "";
          Object.keys(PRESET_CATEGORIES).forEach(cat => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className =
              "preset-cat-btn" + (cat === activeCategory ? " is-active" : "");
            btn.textContent = cat;
            btn.addEventListener("click", () => {
              activeCategory = cat;
              renderCategoryView();
            });
            presetCategories.appendChild(btn);
          });

        }

        function renderPresetList(items) {
          presetList.innerHTML = "";

          if (!items.length) {
            const empty = document.createElement("div");
            empty.className = "preset-feedback";
            empty.textContent = "Sin resultados";
            presetList.appendChild(empty);
            return;
          }

          items.forEach(text => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "preset-item";
            btn.dataset.text = text;
            btn.textContent = text;
            presetList.appendChild(btn);
          });
        }

        function renderCategoryView() {
          presetCategories.style.display = "grid";
          renderPresetCategories();
          // Solo mostrar lista si hay categoría activa
          if (activeCategory) {
            const list = PRESET_CATEGORIES[activeCategory] || [];
            renderPresetList(list);
          } else {
            presetList.innerHTML = "";
          }
        }

        function renderSearchResults(term) {
          presetCategories.style.display = "none";
          const filtered = PRESET_ENTRIES
            .filter(o => o.text.toLowerCase().includes(term))
            .map(o => o.text);
          renderPresetList(filtered);
        }

        function handlePresetSelection(text) {
          if (!text) return;

          let txt = commentArea.value || "";
          if (lineAlreadyExists(txt, text)) {
            showPresetFeedback("Comentario ya registrado anteriormente.");
            return;
          }

          txt = txt ? txt.trimEnd() + "\n" + text : text;

          commentArea.value = txt;

          commentArea.focus();
          const end = commentArea.value.length;
          commentArea.setSelectionRange(end, end);

          const fname = getCurrentFileName();
          if (fname) saveCommentsFor(fname, txt);

          showPresetFeedback("");
          
          // Resetear todo el panel de presets al estado inicial
          resetPresetPanel();
        }

        presetToggleBtn.addEventListener("click", () => {
          if (isPresetPanelOpen) {
            // Si está abierto, resetear todo al estado inicial
            resetPresetPanel();
            return;
          }

          setPresetPanelVisibility(true);
          if (presetSearch.value.trim()) {
            renderSearchResults(presetSearch.value.trim().toLowerCase());
          } else {
            renderCategoryView();
          }
        });

        presetSearch.addEventListener("input", e => {
          const raw = e.target.value;
          const term = raw.trim().toLowerCase();

          if (raw.length) {
            if (!isPresetPanelOpen) setPresetPanelVisibility(true);
            renderSearchResults(term);
          } else {
            if (isPresetPanelOpen) {
              renderCategoryView();
            } else {
              setPresetPanelVisibility(false);
            }
          }
        });

        presetPanel.addEventListener("click", e => {
          const btn = e.target.closest(".preset-item");
          if (!btn) return;

          const text = btn.dataset.text || btn.textContent || "";
          handlePresetSelection(text);
        });

        renderCategoryView();

      /* ==========================================
         ADJUNTAR IMÁGENES
      ========================================== */
      btnAttach.addEventListener("click", () => {
        if (!btnAttach.disabled) attachInput.click();
      });

      attachInput.addEventListener("change", async e => {
        const files = Array.from(e.target.files || []);
        const fname = getCurrentFileName();

        if (!fname || !files.length) return;

        const arr = (ATTACH[fname] ||= []);
        let txt = commentArea.value || "";

        for (const f of files) {
          const blob = new Blob(
            [await f.arrayBuffer()],
            { type: f.type }
          );

          arr.push({ name: f.name, blob });

          txt = txt
            ? txt.trimEnd() + "\nAdjunto: " + f.name + "\n"
            : "Adjunto: " + f.name + "\n";
        }

        commentArea.value = txt;
        saveCommentsFor(fname, txt);
        attachInput.value = "";
        recalcCommentsLayout();
      });

      /* ==========================================
         EXPORTAR TXT o ZIP
      ========================================== */
      btnExport.addEventListener("click", async () => {
        const map = commentsMap();
        const thumbs = [...thumbnailsDiv.querySelectorAll(".thumbnail")];

        const items = thumbs
          .map(t => {
            const name = t.alt || "";
            return {
              name,
              text: (map[name] || "").trim(),
              attachments: ATTACH[name] || []
            };
          })
          .filter(i => i.name);

        let txt = "";
        const withText = items.filter(i => i.text);

        withText.forEach((o, idx) => {
          txt += o.name + "\n" + o.text +
            (idx < withText.length - 1 ? "\n\n" : "");
        });

        const anyAttach = items.some(i =>
          i.attachments && i.attachments.length
        );

        if (!anyAttach) {
          const blob = new Blob([txt], {
            type: "text/plain;charset=utf-8"
          });
          saveAs(blob, "Comentarios_Visor.txt");
          return;
        }

        const zip = new JSZip();
        zip.file("Comentarios_Visor.txt", txt);

        items.forEach(i => {
          (i.attachments || []).forEach(a => {
            zip.file(a.name, a.blob);
          });
        });

        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, "Paquete_Comentarios.zip");
      });

      /* ==========================================
         MODAL "VER TODOS"
      ========================================== */
      function centerCommentsModalPanel() {
        const my = document.getElementById("myModal");
        const panel = document.querySelector(".cm-panel");
        const r = my.getBoundingClientRect();
        const px = Math.round(r.left + r.width / 2);
        const py = Math.round(r.top + r.height / 2);
        panel.style.left = px + "px";
        panel.style.top = py + "px";
        panel.style.transform = "translate(-50%, -50%)";
      }

      function rebuildCommentsModal() {
        const map = commentsMap();
        const items = [...thumbnailsDiv.querySelectorAll(".thumbnail")]
          .map(t => ({
            name: t.alt || "",
            text: (map[t.alt || ""] || "").trim()
          }))
          .filter(o => o.name);

        const withText = items.filter(o => o.text);

        cmBody.innerHTML = "";

        if (!withText.length) {
          const p = document.createElement("div");
          p.className = "empty";
          p.textContent = "NO HAY COMENTARIOS REGISTRADOS";
          cmBody.appendChild(p);
        } else {
          withText.forEach(o => {
            const block = document.createElement("div");
            block.className = "cm-item";

            const fn = document.createElement("div");
            fn.className = "fn";
            fn.textContent = o.name;

            const txt = document.createElement("div");
            txt.className = "cm-text";
            txt.textContent = o.text;

            block.appendChild(fn);
            block.appendChild(txt);
            cmBody.appendChild(block);
          });
        }
      }

      btnViewAll.addEventListener("click", () => {
        rebuildCommentsModal();
        document.getElementById("commentsModal").classList.add("open");
        centerCommentsModalPanel();
      });

      document.getElementById("commentsModal").addEventListener("click", e => {
        if (
          e.target.classList.contains("cm-backdrop") ||
          e.target.id === "cmClose"
        ) {
          e.currentTarget.classList.remove("open");
        }
      });

      window.addEventListener("resize", () => {
        const el = document.getElementById("commentsModal");
        if (el.classList.contains("open")) centerCommentsModalPanel();
      });

      /* ==========================================
         EXPONER acceso al preview principal
      ========================================== */
      window.__v19_getMainPreviewImg = function () {
        const imgs = [...preview.querySelectorAll("img")].filter(
          i => !i.classList.contains("v19-overlay")
        );
        return imgs.length ? imgs[0] : null;
      };
    });
  </script>

  <!-- ===========================
       SISTEMA DE OVERLAYS COMPLETO
  ============================ -->
  <script>
    (function () {
      const OVERLAY_BASE = "img/checkers";

        const TRUTH = [
        { title: "APPLETV", overlay: "APPLETV_Check.png" },
        { title: "199", overlay: "199_PUBLI_Check.png" },
        { title: "FANART_DESTACADO", overlay: "FANART_DESTACADO_PUBLI_Check.png" },
        { title: "FANART", overlay: "FANART_NIVEL1_Check.png" },
        { title: "FANART_MOVIL", overlay: "FANART_MOVIL_Check.png" },
        { title: "IPLUS", overlay: "IPLUS_PUBLI_Check.png" },

        { title: "MOD_DESTACADOS1", overlay: "MOD_DESTACADO1_Check.png" },
        { title: "MOD_DESTACADOS1_SIL", overlay: "MOD_DESTACADO1_SIL_Check.png" },
        { title: "MOD_DESTACADOS2", overlay: "MOD_DESTACADO2_Check.png" },
        { title: "MOD_DESTACADOS2_SIL", overlay: "MOD_DESTACADO2_SIL_Check.png" },
        { title: "MOD_DESTACADOS3", overlay: "MOD_DESTACADO3_Check.png" },
        { title: "MOD_DESTACADOS3_SIL", overlay: "MOD_DESTACADO3_SIL_Check.png" },
        { title: "MOD_N_SIL", overlay: "MOD_N_SIL_Checker.png" },
        { title: "MOD_N", overlay: "MOD_N_Checker.png" },
        { title: "MUX4_FONDO", overlay: "MUX4_FONDO_TXT_PUBLI.png" },
        { title: "MUX4_TXT", overlay: "MUX4_TXT_Check.png" },
        { title: "SMARTPHONE_MUX_FONDO", overlay: "SMARTPHONE_MUX_FONDO_TXT_Check.png"},
        {title: "SMARTPHONE_MUX_TXT", overlay: "SMARTPHONE_MUX_TXT_Check.png"},
        { title: "TITULO_FICHA", overlay: "TITULO_FICHA_Checker.png" },
        { title: "CARTEL_COM_H", overlay: "CC_H_Checker.png" },
        { title: "CARTEL_COM_V", overlay: "CC_V_Checker.png" },
        { title: "CARATULA_V", overlay: "MARCA_CARATULA_V.png" },
        { title: "CARATULA_V_TXT", overlay: "CARATULA_V_Checker.png" },
        { title: "CARATULA_H", overlay: "MARCA_CARATULA_H.png" },
        { title: "CARATULA_H_TXT", overlay: "Caratula_H_Checker.png" },
        { title: "WEB", overlay: "WEBPLAYER_PUBLI_Check.png" },
        { title: "WOW", overlay: "WOW_PUBLI_Check.png" },
        { title: "AMAZON_BG",        overlay: "AMAZON_MOCKUP_Check.png" },
        { title: "AMAZON_SEGURIDAD", overlay: "AMAZON_SEGURIDAD_Check.png" },
        { title: "AMAZON_LOGO",      overlay: "AMAZON_LOGO_Checker.png" },
        { title: "_PERFIL", overlay: "perfil_checker.png" },
        { title: "_SONY", overlay: "SONY_Checker.png" },
        { title: "DESTACADO_DOBLE1", overlay: "MOD_DES_DOBLE_1_Checker.png" },
        { title: "DESTACADO_DOBLE1_SIL", overlay: "MOD_DES_DOBLE_SIL_1_Checker.png" },
        { title: "DESTACADO_DOBLE2", overlay: "MOD_DES_DOBLE_2_Checker.png" },
        { title: "DESTACADO_DOBLE2_SIL", overlay: "MOD_DES_DOBLE_SIL_2_Checker.png" },
        { title: "DESTACADO_DOBLE4", overlay: "MOD_DES_DOBLE_4_Checker.png" },
        { title: "DESTACADO_DOBLE4_SIL", overlay: "MOD_DES_DOBLE_SIL_4_Checker.png" }
      ];




      const KEY_TO_OVERLAY = new Map(
        TRUTH.map(it => [it.title.toUpperCase(), it.overlay])
      );

      const KEY_ALIASES = new Map([
		["_MUX4_TXT", "MUX4_TXT"],
		["MUX4_TXT", "MUX4_TXT"],

		// Alias sin "S" → versión oficial con "S"
		["MOD_DESTACADO1", "MOD_DESTACADOS1"],
		["MOD_DESTACADO2", "MOD_DESTACADOS2"],
		["MOD_DESTACADO3", "MOD_DESTACADOS3"],
		["MOD_DESTACADO4", "MOD_DESTACADOS4"],

		// Alias para carteles de comunicación
		["CC_H", "CARTEL_COM_H"],
		["CC_V", "CARTEL_COM_V"],
		["SONY", "_SONY"],
                ["DESTACADO_DOBLE_SIL_1", "DESTACADO_DOBLE1_SIL"],
                ["DESTACADO_DOBLE_SIL_2", "DESTACADO_DOBLE2_SIL"],
                ["DESTACADO2_DOBLE_SIL", "DESTACADO_DOBLE2_SIL"],
                ["DESTACADO_DOBLE_4", "DESTACADO_DOBLE4"],
                ["DESTACADO_DOBLE_SIL_4", "DESTACADO_DOBLE4_SIL"]
        ]);


      const TITLE_ALIASES = new Map([
        ["SPH. MUX FONDO", "SMARTPHONE_MUX_FONDO"],
        ["SPH MUX FONDO", "SMARTPHONE_MUX_FONDO"],

        ["SPH. MUX TXT", "SMARTPHONE_MUX_TXT"],
        ["SPH MUX TXT", "SMARTPHONE_MUX_TXT"],

        ["SMARTPHONE_MUX_FONDO", "SMARTPHONE_MUX_FONDO"],
        ["SMARTPHONE_MUX_TXT", "SMARTPHONE_MUX_TXT"],

        ["MUX4_TXT", "MUX4_TXT"],
        ["_MUX4_TXT", "MUX4_TXT"]
      ]);

      const PLACE_MUX4 = {
        OFF: {
          ref: { w: 1920, h: 1080 },
          pos: { x: 108, y: 185 }
        },
        FOCO: {
          ref: { w: 1920, h: 1080 },
          pos: { x: 105, y: 456 }
        }
      };

      const PLACE_SMARTPHONE = {
        SMARTPHONE_MUX_FONDO: {
          ref: { w: 1440, h: 2986 },
          pos: { x: 0, y: 1288 }
        }
      };
	  
	  const PLACE_CARATULA = {
        CARATULA_V: {
          ref: { w: 1080, h: 1620 },   // tamaño original del arte
          pos: { x: 0, y: 0 }          // ← PROVISIONAL, para probar
        }
      };

	  const PLACE_CARATULA_H = {
        CARATULA_H: {
          ref: { w: 1920, h: 1080 },   // tamaño original horizontal
          pos: { x: 0, y: 0 }          // ← PROVISIONAL: cubre todo el arte
        }
      };

      const isLive = el => !!(el && el.isConnected);

      const normTitle = s =>
        String(s || "").replace(/\s+/g, " ").trim().toUpperCase();

      function boundaryMatch(h, k) {
        const i = h.indexOf(k);
        if (i === -1) return false;

        const b = i === 0 ? "" : h[i - 1];
        const a = i + k.length >= h.length ? "" : h[i + k.length];

        return (!b || /[_\-\s.\/]/.test(b)) &&
               (!a || /[_\-\s.\/]/.test(a));
      }

      function keyFromTitle(modal) {
        const el = modal.querySelector(
          "h1,h2,.title,.cabecera,strong,[data-role='title']"
        );
        let t = normTitle(el ? el.textContent : "");

        if (TITLE_ALIASES.has(t)) t = TITLE_ALIASES.get(t);
        return KEY_TO_OVERLAY.has(t) ? t : null;
      }

       function keyFromFilename(img) {
        const parts = [];
        if (img?.alt) parts.push(img.alt);
        if (img?.src) parts.push(img.src);

        const partsUp = parts.map(p => String(p || "").toUpperCase());
        const H = partsUp.join(" | ");

        // 0) PERFIL: si aparece _PERFIL en cualquier parte del nombre,
        //    forzamos siempre este formato (igual que hace checkName)
        if (H.includes("_PERFIL")) {
          return "_PERFIL";
        }

        // 1) CASO ESPECIAL _SIL CON BASURA EN MEDIO
        //    Ej.: MOD_DESTACADOS1_V1_IZQ_SIL, _MOD_DESTACADO3_PRE_SIL, etc.
               const silSource = partsUp.find(p => p.includes("_SIL"));
               if (silSource) {
          if (!endsWithSil(silSource)) return null;

          const SIL_BASES = [
  { key: "MOD_DESTACADOS1_SIL", bases: ["MOD_DESTACADOS1", "MOD_DESTACADO1"] },
  { key: "MOD_DESTACADOS2_SIL", bases: ["MOD_DESTACADOS2", "MOD_DESTACADO2"] },
  { key: "MOD_DESTACADOS3_SIL", bases: ["MOD_DESTACADOS3", "MOD_DESTACADO3"] },
  { key: "MOD_DESTACADOS4_SIL", bases: ["MOD_DESTACADOS4", "MOD_DESTACADO4"] },
  { key: "DESTACADO_DOBLE1_SIL", bases: ["DESTACADO_DOBLE1", "DESTACADO_DOBLE_1"] },
  { key: "DESTACADO_DOBLE2_SIL", bases: ["DESTACADO_DOBLE2", "DESTACADO_DOBLE_2"] },
  { key: "DESTACADO_DOBLE4_SIL", bases: ["DESTACADO_DOBLE4", "DESTACADO_DOBLE_4"] }
];


          for (const item of SIL_BASES) {
            for (const b of item.bases) {
              if (H.includes(b)) {
                // Forzamos clave SIL para que use el overlay *_SIL_Check.png
                return item.key;
              }
            }
          }
        }

        // 2) LÓGICA GENERAL
        const ALL_KEYS = TRUTH.map(it => it.title.toUpperCase());

        const KEYS_FOR_FILENAME = [
          "SMARTPHONE_MUX_FONDO",
          "SMARTPHONE_MUX_TXT",
          "MUX4_TXT",
          "_MUX4_TXT",
          "CC_H",
          "CC_V",

          // Variantes sin "S" que queremos reconocer en los filenames
          "MOD_DESTACADO1",
          "MOD_DESTACADO2",
          "MOD_DESTACADO3",
          "MOD_DESTACADO4",
          // SONY sin guion bajo en el nombre de archivo
          "SONY",

          ...ALL_KEYS
            .filter(k => !k.startsWith("SMARTPHONE_") && k !== "MUX4_TXT")
            .sort((a, b) => b.length - a.length)
        ];

        for (const k of KEYS_FOR_FILENAME) {
          if (boundaryMatch(H, k))
            return KEY_ALIASES.get(k) || k;
        }

        return null;
      }



      function ensureOverlayRole(img, role) {
        if (!isLive(img)) return null;

        const p = img.parentElement;
        if (!isLive(p)) return null;

        if (getComputedStyle(p).position === "static")
          p.style.position = "relative";

        let ov = p.querySelector(`img.v19-overlay.role-${role}`);

        if (!ov) {
          ov = document.createElement("img");
          ov.className = `v19-overlay role-${role}`;
          ov.alt = "";
          Object.assign(ov.style, {
            position: "absolute",
            left: "0",
            top: "0",
            width: "100%",
            height: "100%",
            objectFit: "fill",
            objectPosition: "center",
            pointerEvents: "none",
            zIndex: role === "base" ? "3" : "4",
            border: "0",
            background: "transparent"
          });
          p.appendChild(ov);
        }

        return ov;
      }

      function fitOverlayFill(ov, img) {
        if (!isLive(ov) || !isLive(img) || !isLive(img.parentElement)) return;

        const pr = img.parentElement.getBoundingClientRect();
        const ir = img.getBoundingClientRect();

        ov.style.left = ir.left - pr.left + "px";
        ov.style.top = ir.top - pr.top + "px";
        ov.style.width = ir.width + "px";
        ov.style.height = ir.height + "px";
      }

// FANART_MOVIL – overlay más alto que la imagen (1440x3117 sobre 1440x2986)
function fitOverlayFanartMovil(ov, img) {
  if (!isLive(ov) || !isLive(img) || !isLive(img.parentElement)) return;

  const pr = img.parentElement.getBoundingClientRect();
  const ir = img.getBoundingClientRect();

  // 1) El ancho del overlay = ancho visible de la imagen
  const overlayW = ir.width;
  // 2) Alto del overlay según su proporción real 1440x3117
  const overlayH = overlayW * (3117 / 1440);

  // 3) Alineamos top-left con la imagen
  const left = ir.left - pr.left;
  const top  = ir.top  - pr.top;

  ov.style.left   = left + "px";
  ov.style.top    = top  + "px";
  ov.style.width  = overlayW + "px";
  ov.style.height = overlayH + "px";
  ov.style.objectFit = "fill";
  ov.style.display   = "";
}

// AMAZON_BG – overlay 1920x1080 sobre imagen 1920x720 (alineado arriba)



function fitOverlayRect(ov, img, placement, txtRuleKey) {
  if (!placement ||
      !isLive(ov) ||
      !isLive(img) ||
      !isLive(img.parentElement)) {
    if (isLive(ov)) ov.style.display = "none";
    return;
  }

  const { ref, pos } = placement;
  if (!ref || !pos) {
    ov.style.display = "none";
    return;
  }

  const pr = img.parentElement.getBoundingClientRect();
  const ir = img.getBoundingClientRect();

  const sX = ir.width / ref.w;
  const sY = ir.height / ref.h;
  const s  = Math.min(sX, sY);

  const rule = typeof RU !== "undefined" && RU[txtRuleKey]
    ? RU[txtRuleKey]
    : null;

  const rW = rule?.w ?? 0;
  const rH = rule?.h ?? 0;

  const ox = pos.x * s;
  const oy = pos.y * s;

  ov.style.left = (ir.left - pr.left + ox) + "px";
  ov.style.top  = (ir.top  - pr.top  + oy) + "px";

  if (rW > 0 && rH > 0) {
    ov.style.width  = (rW * s) + "px";
    ov.style.height = (rH * s) + "px";
  }

  ov.style.objectFit = "fill";
  ov.style.display   = "";
}



      function findSibling(byNeedle, baseName) {
        const U = String(baseName || "").toUpperCase();
        const ix = U.indexOf(byNeedle);
        if (ix < 0) return null;

        const stem = U.slice(0, ix);

        const cand = (window.LOADED_ITEMS || [])
          .filter(it => /\.PNG($|\?)/i.test(it.name))
          .map(it => ({
            it,
            UU: String(it.name).toUpperCase()
          }))
          .filter(o =>
            o.UU.startsWith(stem) &&
            o.UU.includes(byNeedle.replace("_FONDO", "_TXT"))
          )
          .sort((a, b) => b.UU.length - a.UU.length)[0];

        return cand ? cand.it : null;
      }

      function findAmazonLogo(baseName) {
        const U = String(baseName || "").toUpperCase();
        const idx = U.indexOf("AMAZON_BG");
        const stem = idx >= 0 ? U.slice(0, idx) : U;

        const cand = (window.LOADED_ITEMS || [])
          .filter(it => /\.PNG($|\?)/i.test(it.name))
          .map(it => ({ it, UU: String(it.name).toUpperCase() }))
          .filter(o =>
            o.UU.startsWith(stem) &&
            o.UU.includes("AMAZON_LOGO")
          )
          .sort((a, b) => b.UU.length - a.UU.length)[0];

        return cand ? cand.it : null;
      }


      let roBase = null;
      let roSib = null;
      let roLogo = null;   // ← nuevo observer para el logo

      let lastFailBase = "";
      let lastFailSib = "";

      const getMux4Placement = () =>
        window.focoOn ? PLACE_MUX4.FOCO : PLACE_MUX4.OFF;

      function getVisibleModal() {
        const c = [
          ...document.querySelectorAll(
            "[role='dialog'],[aria-modal='true']," +
            "[class*='modal' i],[class*='visor' i]," +
            "[class*='viewer' i],[class*='lightbox' i]"
          )
        ];

        let best = null;
        let area = 0;

        for (const el of c) {
          const cs = getComputedStyle(el);
          if (
            cs.display === "none" ||
            cs.visibility === "hidden" ||
            el.offsetWidth <= 0 ||
            el.offsetHeight <= 0
          )
            continue;

          const r = el.getBoundingClientRect();
          const a = r.width * r.height;

          if (a > area) {
            best = el;
            area = a;
          }
        }

        return best;
      }

      function getMainModalImg(modal) {
        const img =
          typeof window.__v19_getMainPreviewImg === "function"
            ? window.__v19_getMainPreviewImg()
            : null;

        if (img && isLive(img)) return img;

        const imgs = Array.from(modal.querySelectorAll("img")).filter(
          i => !i.classList.contains("v19-overlay")
        );

        let best = null;
        let area = 0;

        for (const i of imgs) {
          const r = i.getBoundingClientRect();
          const vis = r.width > 120 && r.height > 120;
          const a = r.width * r.height;

          if (vis && a > area) {
            best = i;
            area = a;
          }
        }
        return best;
      }

      function disconnectObservers() {
        if (roBase) {
          roBase.disconnect();
          roBase = null;
        }
        if (roSib) {
          roSib.disconnect();
          roSib = null;
        }
        if (roLogo) {
          roLogo.disconnect();
          roLogo = null;
        }
      }


// AMAZON — bloque centrado (1920x1080), BG arriba, overlays encima
function fitOverlayAmazon(mainImg, baseOv, sibOv) {
  if (!isLive(mainImg) || !isLive(mainImg.parentElement)) return;

  const parent = mainImg.parentElement;
  const pr = parent.getBoundingClientRect();
  if (pr.width <= 0 || pr.height <= 0) return;

  // Aspect ratio del bloque completo (mockup)
  const aspect = 1920 / 1080;

  // 1) CÁLCULO DEL BLOQUE CENTRADO (16:9)
  let W = pr.width;
  let H = W / aspect;

  if (H > pr.height) {
    H = pr.height;
    W = H * aspect;
  }

  const left = (pr.width - W) / 2;
  const top  = (pr.height - H) / 2;

  // 2) FONDO AMAZON_BG — pegado a la parte superior del bloque
  Object.assign(mainImg.style, {
    position: "absolute",
    left: left + "px",
    top: top + "px",
    width: W + "px",
    height: "auto",
    objectFit: "cover"
  });

  // 3) OVERLAY BASE (mockup)
  if (isLive(baseOv)) {
    Object.assign(baseOv.style, {
      position: "absolute",
      left: left + "px",
      top: top + "px",
      width: W + "px",
      height: H + "px",
      objectFit: "fill",
      display: ""
    });
  }

  // 4) OVERLAY SEGURIDAD
  if (isLive(sibOv)) {
    Object.assign(sibOv.style, {
      position: "absolute",
      left: left + "px",
      top: top + "px",
      width: W + "px",
      height: H + "px",
      objectFit: "fill",
      display: ""
    });
  }
}

      function fitAmazonLogo(mainImg, logoOv) {
        if (!isLive(mainImg) || !isLive(mainImg.parentElement) || !isLive(logoOv)) return;

        const parent = mainImg.parentElement;
        const pr = parent.getBoundingClientRect();
        if (pr.width <= 0 || pr.height <= 0) return;

        // mismo bloque 16:9 que en fitOverlayAmazon
        const aspect = 1920 / 1080;
        let W = pr.width;
        let H = W / aspect;

        if (H > pr.height) {
          H = pr.height;
          W = H * aspect;
        }

        const leftBlock = (pr.width - W) / 2;
        const topBlock  = (pr.height - H) / 2;

        // factor de escala respecto a 1920px de ancho
        const s = W / 1920;

// === AJUSTES DEL LOGO (coordenadas en la maqueta 1920x1080) ===
// Mueve estos valores para colocar el logo EXACTAMENTE donde quieras
const OFFSET_X = 104;   // derecha/izquierda
const OFFSET_Y = 65;    // arriba/abajo

        const nW = logoOv.naturalWidth  * s;
        const nH = logoOv.naturalHeight * s;

        // De momento: pegado arriba a la izquierda del bloque
        logoOv.style.position = "absolute";
        logoOv.style.left = (leftBlock + OFFSET_X * s) + "px";
        logoOv.style.top  = (topBlock + OFFSET_Y * s) + "px";
        logoOv.style.width  = nW + "px";
        logoOv.style.height = nH + "px";
        logoOv.style.objectFit = "contain";
        logoOv.style.display = "";
      }



      /* ==========================================
         MÁQUINA PRINCIPAL DE OVERLAYS
      ========================================== */
      function update() {
        const modal = getVisibleModal();
        if (!modal) return disconnectObservers();

        const mainImg = getMainModalImg(modal);
        if (!isLive(mainImg)) return disconnectObservers();

        let key = keyFromTitle(modal);
        if (!key) key = keyFromFilename(mainImg);

        if (key && KEY_ALIASES.has(key))
          key = KEY_ALIASES.get(key);

        const baseOv = ensureOverlayRole(mainImg, "base");
        const sibOv = ensureOverlayRole(mainImg, "sib");

        if (!baseOv || !sibOv) return disconnectObservers();

        baseOv.style.display = "none";
        sibOv.style.display = "none";

        if (!key) {
          disconnectObservers();
          return;
        }

        /* ==========================================
           CASO MUX4_FONDO
        ========================================== */
        if (key === "MUX4_FONDO") {
          const baseFile = window.focoOn
            ? "MUX4_FONDO_TXT_PUBLI_FOCO.png"
            : KEY_TO_OVERLAY.get("MUX4_FONDO") ||
              "MUX4_FONDO_TXT_PUBLI.png";

          if (baseFile) {
            const srcB = `${OVERLAY_BASE}/${baseFile}`;

            baseOv.onerror = () => {
              lastFailBase = srcB;
              baseOv.style.display = "none";
            };

            baseOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailBase === srcB) lastFailBase = "";
              fitOverlayFill(baseOv, mainImg);
            };

            if (baseOv.getAttribute("src") !== srcB)
              baseOv.setAttribute("src", srcB);

            fitOverlayFill(baseOv, mainImg);
            baseOv.style.display = "";
          }

          const sib = findSibling("MUX4_FONDO", mainImg.alt || "");
          let srcS = null;

          if (sib && sib.src) {
            srcS = sib.src;
          } else {
            const sibFile = KEY_TO_OVERLAY.get("MUX4_TXT");
            if (sibFile) srcS = `${OVERLAY_BASE}/${sibFile}`;
          }

          if (srcS) {
            const placement = getMux4Placement();

            sibOv.onerror = () => {
              lastFailSib = srcS;
              sibOv.style.display = "none";
            };

            sibOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailSib === srcS) lastFailSib = "";
              fitOverlayRect(
                sibOv,
                mainImg,
                placement,
                "MUX4_TXT"
              );
            };

            if (sibOv.getAttribute("src") !== srcS)
              sibOv.setAttribute("src", srcS);

            fitOverlayRect(
              sibOv,
              mainImg,
              placement,
              "MUX4_TXT"
            );

            sibOv.style.display = "";
          }

          disconnectObservers();

          roBase = new ResizeObserver(() =>
            fitOverlayFill(baseOv, mainImg)
          );
          roSib = new ResizeObserver(() =>
            fitOverlayRect(
              sibOv,
              mainImg,
              getMux4Placement(),
              "MUX4_TXT"
            )
          );

          roBase.observe(mainImg);
          roBase.observe(mainImg.parentElement);

          roSib.observe(mainImg);
          roSib.observe(mainImg.parentElement);

          return;
        }
		  

        /* ==========================================
           CASO SMARTPHONE_MUX_FONDO
        ========================================== */
        if (key === "SMARTPHONE_MUX_FONDO") {
          const smBaseFile = KEY_TO_OVERLAY.get("SMARTPHONE_MUX_FONDO");

          if (smBaseFile) {
            const srcB = `${OVERLAY_BASE}/${smBaseFile}`;

            baseOv.onerror = () => {
              lastFailBase = srcB;
              baseOv.style.display = "none";
            };

            baseOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailBase === srcB) lastFailBase = "";
              fitOverlayFill(baseOv, mainImg);
            };

            if (baseOv.getAttribute("src") !== srcB)
              baseOv.setAttribute("src", srcB);

            fitOverlayFill(baseOv, mainImg);
            baseOv.style.display = "";
          }

          const smSib = findSibling(
            "SMARTPHONE_MUX_FONDO",
            mainImg.alt || ""
          );

          let srcS = null;

          if (smSib && smSib.src) {
            srcS = smSib.src;
          } else {
            const f = KEY_TO_OVERLAY.get("SMARTPHONE_MUX_TXT");
            if (f) srcS = `${OVERLAY_BASE}/${f}`;
          }

          if (srcS) {
            const placement =
              PLACE_SMARTPHONE.SMARTPHONE_MUX_FONDO;

            sibOv.onerror = () => {
              lastFailSib = srcS;
              sibOv.style.display = "none";
            };

            sibOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailSib === srcS) lastFailSib = "";
              fitOverlayRect(
                sibOv,
                mainImg,
                placement,
                "SMARTPHONE_MUX_TXT"
              );
            };

            if (sibOv.getAttribute("src") !== srcS)
              sibOv.setAttribute("src", srcS);

            fitOverlayRect(
              sibOv,
              mainImg,
              placement,
              "SMARTPHONE_MUX_TXT"
            );

            sibOv.style.display = "";
          }

          disconnectObservers();

          roBase = new ResizeObserver(() =>
            fitOverlayFill(baseOv, mainImg)
          );

          roSib = new ResizeObserver(() =>
            fitOverlayRect(
              sibOv,
              mainImg,
              PLACE_SMARTPHONE.SMARTPHONE_MUX_FONDO,
              "SMARTPHONE_MUX_TXT"
            )
          );

          roBase.observe(mainImg);
          roBase.observe(mainImg.parentElement);

          roSib.observe(mainImg);
          roSib.observe(mainImg.parentElement);

          return;
        }
		
		        /* ==========================================
           CASO CARATULA_V (doble overlay)
        ========================================== */
        if (key === "CARATULA_V") {
          const baseFile = KEY_TO_OVERLAY.get("CARATULA_V");
          const txtFile  = KEY_TO_OVERLAY.get("CARATULA_V_TXT");

          // --- Overlay base: MARCA_CARATULA_V.png a pantalla ---
          if (baseFile) {
            const srcB = `${OVERLAY_BASE}/${baseFile}`;

            baseOv.onerror = () => {
              lastFailBase = srcB;
              baseOv.style.display = "none";
            };

            baseOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailBase === srcB) lastFailBase = "";
              fitOverlayFill(baseOv, mainImg);
            };

            if (baseOv.getAttribute("src") !== srcB)
              baseOv.setAttribute("src", srcB);

            fitOverlayFill(baseOv, mainImg);
            baseOv.style.display = "";
          }

          // --- Segundo overlay: CARATULA_V_TXT_Check.png en rectángulo ---
          if (txtFile) {
            const srcS = `${OVERLAY_BASE}/${txtFile}`;
            const placement = PLACE_CARATULA.CARATULA_V;

            sibOv.onerror = () => {
              lastFailSib = srcS;
              sibOv.style.display = "none";
            };

            sibOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailSib === srcS) lastFailSib = "";
              fitOverlayRect(
                sibOv,
                mainImg,
                placement,
                "CARATULA_V_TXT"
              );
            };

            if (sibOv.getAttribute("src") !== srcS)
              sibOv.setAttribute("src", srcS);

            fitOverlayRect(
              sibOv,
              mainImg,
              placement,
              "CARATULA_V_TXT"
            );

            sibOv.style.display = "";
          } else {
            // Si no hay PNG de TXT, ocultamos el sib por seguridad
            sibOv.removeAttribute("src");
            sibOv.style.display = "none";
          }

          // --- Observers para que se reajusten al redimensionar ---
          disconnectObservers();

          roBase = new ResizeObserver(() =>
            fitOverlayFill(baseOv, mainImg)
          );

          roSib = new ResizeObserver(() =>
            fitOverlayRect(
              sibOv,
              mainImg,
              PLACE_CARATULA.CARATULA_V,
              "CARATULA_V_TXT"
            )
          );

          roBase.observe(mainImg);
          roBase.observe(mainImg.parentElement);

          roSib.observe(mainImg);
          roSib.observe(mainImg.parentElement);

          return;
        }

        /* ==========================================
           CASO CARATULA_H (doble overlay)
        ========================================== */
        if (key === "CARATULA_H") {
          const baseFile = KEY_TO_OVERLAY.get("CARATULA_H");
          const txtFile  = KEY_TO_OVERLAY.get("CARATULA_H_TXT");

          // --- Overlay base: MARCA_CARATULA_H.png a pantalla ---
          if (baseFile) {
            const srcB = `${OVERLAY_BASE}/${baseFile}`;

            baseOv.onerror = () => {
              lastFailBase = srcB;
              baseOv.style.display = "none";
            };

            baseOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailBase === srcB) lastFailBase = "";
              fitOverlayFill(baseOv, mainImg);
            };

            if (baseOv.getAttribute("src") !== srcB)
              baseOv.setAttribute("src", srcB);

            fitOverlayFill(baseOv, mainImg);
            baseOv.style.display = "";
          }

          // --- Segundo overlay: Caratula_H_Checker.png en rectángulo ---
          if (txtFile) {
            const srcS = `${OVERLAY_BASE}/${txtFile}`;
            const placement = PLACE_CARATULA_H.CARATULA_H;

            sibOv.onerror = () => {
              lastFailSib = srcS;
              sibOv.style.display = "none";
            };

            sibOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailSib === srcS) lastFailSib = "";
              fitOverlayRect(
                sibOv,
                mainImg,
                placement,
                "CARATULA_H_TXT"
              );
            };

            if (sibOv.getAttribute("src") !== srcS)
              sibOv.setAttribute("src", srcS);

            fitOverlayRect(
              sibOv,
              mainImg,
              placement,
              "CARATULA_H_TXT"
            );

            sibOv.style.display = "";
          } else {
            // Si no hay PNG de TXT, ocultamos el sib por seguridad
            sibOv.removeAttribute("src");
            sibOv.style.display = "none";
          }

          // --- Observers para que se reajusten al redimensionar ---
          disconnectObservers();

          roBase = new ResizeObserver(() =>
            fitOverlayFill(baseOv, mainImg)
          );

          roSib = new ResizeObserver(() =>
            fitOverlayRect(
              sibOv,
              mainImg,
              PLACE_CARATULA_H.CARATULA_H,
              "CARATULA_H_TXT"
            )
          );

          roBase.observe(mainImg);
          roBase.observe(mainImg.parentElement);

          roSib.observe(mainImg);
          roSib.observe(mainImg.parentElement);

          return;
        }
        /* ==========================================
           CASO AMAZON_BG (doble overlay + logo)
        ========================================== */
        if (key === "AMAZON_BG") {
          const mockFile = "AMAZON_MOCKUP_Check.png";
          const segFile  = "AMAZON_SEGURIDAD_Check.png";

          // --- BASE OVERLAY (MOCKUP) ---
          if (mockFile) {
            const srcB = `${OVERLAY_BASE}/${mockFile}`;

            baseOv.onerror = () => {
              lastFailBase = srcB;
              baseOv.style.display = "none";
            };

            baseOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailBase === srcB) lastFailBase = "";
              fitOverlayAmazon(mainImg, baseOv, sibOv);
            };

            if (baseOv.getAttribute("src") !== srcB)
              baseOv.setAttribute("src", srcB);

            baseOv.style.display = "";
          }

          // --- OVERLAY SEGURIDAD ---
          if (segFile) {
            const srcS = `${OVERLAY_BASE}/${segFile}`;

            sibOv.onerror = () => {
              lastFailSib = srcS;
              sibOv.style.display = "none";
            };

            sibOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailSib === srcS) lastFailSib = "";
              fitOverlayAmazon(mainImg, baseOv, sibOv);
            };

            if (sibOv.getAttribute("src") !== srcS)
              sibOv.setAttribute("src", srcS);

            sibOv.style.display = "";
          } else {
            sibOv.removeAttribute("src");
            sibOv.style.display = "none";
          }

          // --- LOGO AMAZON (archivo AMAZON_LOGO hermano) ---
          const logoItem = findAmazonLogo(mainImg.alt || "");
          let logoOv = null;

          if (logoItem) {
            logoOv = ensureOverlayRole(mainImg, "logo");

            const srcL = logoItem.src;

            logoOv.onerror = () => {
              logoOv.style.display = "none";
            };

            logoOv.onload = () => {
              if (!isLive(mainImg)) return;
              fitAmazonLogo(mainImg, logoOv);
            };

            if (logoOv.getAttribute("src") !== srcL)
              logoOv.setAttribute("src", srcL);
          } else if (baseOv && baseOv.parentElement) {
            // si no hay logo, lo ocultamos
            const tmp = baseOv.parentElement.querySelector("img.v19-overlay.role-logo");
            if (tmp) {
              tmp.removeAttribute("src");
              tmp.style.display = "none";
            }
          }

          // --- OBSERVERS ---
          disconnectObservers();

          roBase = new ResizeObserver(() =>
            fitOverlayAmazon(mainImg, baseOv, sibOv)
          );
          roSib = new ResizeObserver(() =>
            fitOverlayAmazon(mainImg, baseOv, sibOv)
          );

          if (logoItem && logoOv) {
            roLogo = new ResizeObserver(() =>
              fitAmazonLogo(mainImg, logoOv)
            );
          }

          roBase.observe(mainImg);
          roBase.observe(mainImg.parentElement);

          roSib.observe(mainImg);
          roSib.observe(mainImg.parentElement);

          if (roLogo && logoOv) {
            roLogo.observe(mainImg);
            roLogo.observe(mainImg.parentElement);
          }

          // Primer cálculo inmediato
          fitOverlayAmazon(mainImg, baseOv, sibOv);
          if (logoItem && logoOv) {
            fitAmazonLogo(mainImg, logoOv);
          }

          return;
        }

        /* ==========================================
           CASO AMAZON_LOGO (checker simple con botón TXT)
        ========================================== */
        if (key === "AMAZON_LOGO") {
          const file = KEY_TO_OVERLAY.get("AMAZON_LOGO");

          // No usamos overlay base en este formato
          baseOv.removeAttribute("src");
          baseOv.style.display = "none";

          if (file) {
            const srcS = `${OVERLAY_BASE}/${file}`;

            sibOv.onerror = () => {
              lastFailSib = srcS;
              sibOv.style.display = "none";
            };

            sibOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailSib === srcS) lastFailSib = "";
              // El checker cubre exactamente el logo
              fitOverlayFill(sibOv, mainImg);
            };

            if (sibOv.getAttribute("src") !== srcS)
              sibOv.setAttribute("src", srcS);

            // Primera colocación inmediata
            fitOverlayFill(sibOv, mainImg);
            sibOv.style.display = "";
          } else {
            sibOv.removeAttribute("src");
            sibOv.style.display = "none";
          }

          // Observers solo para el checker del logo
          disconnectObservers();

          roSib = new ResizeObserver(() =>
            fitOverlayFill(sibOv, mainImg)
          );

          roSib.observe(mainImg);
          roSib.observe(mainImg.parentElement);

          return;
        }

/* ==========================================
   CASO _SONY (checker simple con botón ZONA DE SEGURIDAD / TXT)
========================================== */
if (key === "_SONY") {
  const file = KEY_TO_OVERLAY.get("_SONY");

  // No usamos overlay base en este formato
  baseOv.removeAttribute("src");
  baseOv.style.display = "none";

  if (file) {
    const srcS = `${OVERLAY_BASE}/${file}`;

    sibOv.onerror = () => {
      lastFailSib = srcS;
      sibOv.style.display = "none";
    };

    sibOv.onload = () => {
      if (!isLive(mainImg)) return;
      if (lastFailSib === srcS) lastFailSib = "";
      // El checker cubre exactamente el arte SONY
      fitOverlayFill(sibOv, mainImg);
    };

    if (sibOv.getAttribute("src") !== srcS)
      sibOv.setAttribute("src", srcS);

    // Primera colocación inmediata
    fitOverlayFill(sibOv, mainImg);
    sibOv.style.display = "";
  } else {
    sibOv.removeAttribute("src");
    sibOv.style.display = "none";
  }

  // Observers solo para el checker SONY
  disconnectObservers();

  roSib = new ResizeObserver(() =>
    fitOverlayFill(sibOv, mainImg)
  );

  roSib.observe(mainImg);
  roSib.observe(mainImg.parentElement);

  return;
}

/* ==========================================
   CASO DESTACADO_DOBLE1 (checker simple con botón ZONA DE SEGURIDAD / TXT)
========================================== */
if (key === "DESTACADO_DOBLE1") {
  const file = KEY_TO_OVERLAY.get("DESTACADO_DOBLE1");

  // No usamos overlay base en este formato
  baseOv.removeAttribute("src");
  baseOv.style.display = "none";

  if (file) {
    const srcS = `${OVERLAY_BASE}/${file}`;

    sibOv.onerror = () => {
      lastFailSib = srcS;
      sibOv.style.display = "none";
    };

    sibOv.onload = () => {
      if (!isLive(mainImg)) return;
      if (lastFailSib === srcS) lastFailSib = "";
      // El checker cubre exactamente el arte DESTACADO_DOBLE1
      fitOverlayFill(sibOv, mainImg);
    };

    if (sibOv.getAttribute("src") !== srcS)
      sibOv.setAttribute("src", srcS);

    // Primera colocación inmediata
    fitOverlayFill(sibOv, mainImg);
    sibOv.style.display = "";
  } else {
    sibOv.removeAttribute("src");
    sibOv.style.display = "none";
  }

  // Observers solo para el checker
  disconnectObservers();

  roSib = new ResizeObserver(() =>
    fitOverlayFill(sibOv, mainImg)
  );

  roSib.observe(mainImg);
  roSib.observe(mainImg.parentElement);

  return;
}

/* ==========================================
   CASO DESTACADO_DOBLE1_SIL (checker simple con botón ZONA DE SEGURIDAD / TXT)
========================================== */
if (key === "DESTACADO_DOBLE1_SIL") {
  const file = KEY_TO_OVERLAY.get("DESTACADO_DOBLE1_SIL");

  // No usamos overlay base en este formato
  baseOv.removeAttribute("src");
  baseOv.style.display = "none";

  if (file) {
    const srcS = `${OVERLAY_BASE}/${file}`;

    sibOv.onerror = () => {
      lastFailSib = srcS;
      sibOv.style.display = "none";
    };

    sibOv.onload = () => {
      if (!isLive(mainImg)) return;
      if (lastFailSib === srcS) lastFailSib = "";
      // El checker cubre exactamente el arte DESTACADO_DOBLE1_SIL
      fitOverlayFill(sibOv, mainImg);
    };

    if (sibOv.getAttribute("src") !== srcS)
      sibOv.setAttribute("src", srcS);

    // Primera colocación inmediata
    fitOverlayFill(sibOv, mainImg);
    sibOv.style.display = "";
  } else {
    sibOv.removeAttribute("src");
    sibOv.style.display = "none";
  }

  // Observers solo para el checker
  disconnectObservers();

  roSib = new ResizeObserver(() =>
    fitOverlayFill(sibOv, mainImg)
  );

  roSib.observe(mainImg);
  roSib.observe(mainImg.parentElement);

  return;
}
		  
/* ==========================================
   CASO DESTACADO_DOBLE4_SIL (checker simple con botón ZONA DE SEGURIDAD / TXT)
========================================== */
if (key === "DESTACADO_DOBLE4_SIL") {
  const file = KEY_TO_OVERLAY.get("DESTACADO_DOBLE4_SIL");

  // No usamos overlay base en este formato
  baseOv.removeAttribute("src");
  baseOv.style.display = "none";

  if (file) {
    const srcS = `${OVERLAY_BASE}/${file}`;

    sibOv.onerror = () => {
      lastFailSib = srcS;
      sibOv.style.display = "none";
    };

    sibOv.onload = () => {
      if (!isLive(mainImg)) return;
      if (lastFailSib === srcS) lastFailSib = "";
      // El checker cubre exactamente el arte DESTACADO_DOBLE4_SIL
      fitOverlayFill(sibOv, mainImg);
    };

    if (sibOv.getAttribute("src") !== srcS)
      sibOv.setAttribute("src", srcS);

    // Primera colocación inmediata
    fitOverlayFill(sibOv, mainImg);
    sibOv.style.display = "";
  } else {
    sibOv.removeAttribute("src");
    sibOv.style.display = "none";
  }

  // Observers solo para el checker
  disconnectObservers();

  roSib = new ResizeObserver(() =>
    fitOverlayFill(sibOv, mainImg)
  );

  roSib.observe(mainImg);
  roSib.observe(mainImg.parentElement);

  return;
}

/* ==========================================
   CASO DESTACADO_DOBLE4 (checker simple con botón ZONA DE SEGURIDAD / TXT)
========================================== */
if (key === "DESTACADO_DOBLE4") {
  const file = KEY_TO_OVERLAY.get("DESTACADO_DOBLE4");

  // No usamos overlay base en este formato
  baseOv.removeAttribute("src");
  baseOv.style.display = "none";

  if (file) {
    const srcS = `${OVERLAY_BASE}/${file}`;

    sibOv.onerror = () => {
      lastFailSib = srcS;
      sibOv.style.display = "none";
    };

    sibOv.onload = () => {
      if (!isLive(mainImg)) return;
      if (lastFailSib === srcS) lastFailSib = "";
      // El checker cubre exactamente el arte DESTACADO_DOBLE4
      fitOverlayFill(sibOv, mainImg);
    };

    if (sibOv.getAttribute("src") !== srcS)
      sibOv.setAttribute("src", srcS);

    // Primera colocación inmediata
    fitOverlayFill(sibOv, mainImg);
    sibOv.style.display = "";
  } else {
    sibOv.removeAttribute("src");
    sibOv.style.display = "none";
  }

  // Observers solo para el checker
  disconnectObservers();

  roSib = new ResizeObserver(() =>
    fitOverlayFill(sibOv, mainImg)
  );

  roSib.observe(mainImg);
  roSib.observe(mainImg.parentElement);

  return;
}


/* ==========================================
   CASO DESTACADO_DOBLE2 (checker simple con botón ZONA DE SEGURIDAD / TXT)
========================================== */
if (key === "DESTACADO_DOBLE2") {
  const file = KEY_TO_OVERLAY.get("DESTACADO_DOBLE2");

  // No usamos overlay base en este formato
  baseOv.removeAttribute("src");
  baseOv.style.display = "none";

  if (file) {
    const srcS = `${OVERLAY_BASE}/${file}`;

    sibOv.onerror = () => {
      lastFailSib = srcS;
      sibOv.style.display = "none";
    };

    sibOv.onload = () => {
      if (!isLive(mainImg)) return;
      if (lastFailSib === srcS) lastFailSib = "";
      // El checker cubre exactamente el arte DESTACADO_DOBLE2
      fitOverlayFill(sibOv, mainImg);
    };

    if (sibOv.getAttribute("src") !== srcS)
      sibOv.setAttribute("src", srcS);

    // Primera colocación inmediata
    fitOverlayFill(sibOv, mainImg);
    sibOv.style.display = "";
  } else {
    sibOv.removeAttribute("src");
    sibOv.style.display = "none";
  }

  // Observers solo para el checker
  disconnectObservers();

  roSib = new ResizeObserver(() =>
    fitOverlayFill(sibOv, mainImg)
  );

  roSib.observe(mainImg);
  roSib.observe(mainImg.parentElement);

  return;
}

/* ==========================================
   CASO DESTACADO_DOBLE2_SIL (checker simple con botón ZONA DE SEGURIDAD / TXT)
========================================== */
if (key === "DESTACADO_DOBLE2_SIL") {
  const file = KEY_TO_OVERLAY.get("DESTACADO_DOBLE2_SIL");

  // No usamos overlay base en este formato
  baseOv.removeAttribute("src");
  baseOv.style.display = "none";

  if (file) {
    const srcS = `${OVERLAY_BASE}/${file}`;

    sibOv.onerror = () => {
      lastFailSib = srcS;
      sibOv.style.display = "none";
    };

    sibOv.onload = () => {
      if (!isLive(mainImg)) return;
      if (lastFailSib === srcS) lastFailSib = "";
      // El checker cubre exactamente el arte DESTACADO_DOBLE2_SIL
      fitOverlayFill(sibOv, mainImg);
    };

    if (sibOv.getAttribute("src") !== srcS)
      sibOv.setAttribute("src", srcS);

    // Primera colocación inmediata
    fitOverlayFill(sibOv, mainImg);
    sibOv.style.display = "";
  } else {
    sibOv.removeAttribute("src");
    sibOv.style.display = "none";
  }

  // Observers solo para el checker
  disconnectObservers();

  roSib = new ResizeObserver(() =>
    fitOverlayFill(sibOv, mainImg)
  );

  roSib.observe(mainImg);
  roSib.observe(mainImg.parentElement);

  return;
}






        /* ==========================================
           CASO FANART (doble nivel)
        ========================================== */
        if (key === "FANART") {
          const nivel = window.fanartNivel || 1;

          const file = nivel === 1
            ? "FANART_NIVEL1_Check.png"
            : "FANART_NIVEL2_Check.png";

          const srcB = `${OVERLAY_BASE}/${file}`;

          // --- Overlay base (actúa como checker principal)
          baseOv.onerror = () => {
            lastFailBase = srcB;
            baseOv.style.display = "none";
          };

          baseOv.onload = () => {
            if (!isLive(mainImg)) return;
            if (lastFailBase === srcB) lastFailBase = "";
            fitOverlayFill(baseOv, mainImg);
          };

          if (baseOv.getAttribute("src") !== srcB)
            baseOv.setAttribute("src", srcB);

          fitOverlayFill(baseOv, mainImg);
          baseOv.style.display = "";

          // --- FANART no usa segundo overlay
          sibOv.removeAttribute("src");
          sibOv.style.display = "none";

          // --- Observers solo para base
          disconnectObservers();

          roBase = new ResizeObserver(() =>
            fitOverlayFill(baseOv, mainImg)
          );

          roBase.observe(mainImg);
          roBase.observe(mainImg.parentElement);

          return;
        }

        /* ==========================================
           CASO FANART_MOVIL (overlay más alto)
        ========================================== */
        if (key === "FANART_MOVIL") {
          const file = KEY_TO_OVERLAY.get("FANART_MOVIL");

          if (file) {
            const srcB = `${OVERLAY_BASE}/${file}`;

            baseOv.onerror = () => {
              lastFailBase = srcB;
              baseOv.style.display = "none";
            };

            baseOv.onload = () => {
              if (!isLive(mainImg)) return;
              if (lastFailBase === srcB) lastFailBase = "";
              fitOverlayFanartMovil(baseOv, mainImg);
            };

            if (baseOv.getAttribute("src") !== srcB)
              baseOv.setAttribute("src", srcB);

            fitOverlayFanartMovil(baseOv, mainImg);
            baseOv.style.display = "";
          }

          // FANART_MOVIL no usa segundo overlay
          sibOv.removeAttribute("src");
          sibOv.style.display = "none";

          // Observers solo para el base, recalculando en resize
          disconnectObservers();

          roBase = new ResizeObserver(() =>
            fitOverlayFanartMovil(baseOv, mainImg)
          );

          roBase.observe(mainImg);
          roBase.observe(mainImg.parentElement);

          return;
        }

        /* ==========================================
           CASO GENERAL (overlays simples)
        ========================================== */
        const file = KEY_TO_OVERLAY.get(key);

        if (file) {
          const src = `${OVERLAY_BASE}/${file}`;

          baseOv.onerror = () => {
            lastFailBase = src;
            baseOv.style.display = "none";
          };

          baseOv.onload = () => {
            if (!isLive(mainImg)) return;
            if (lastFailBase === src) lastFailBase = "";
            fitOverlayFill(baseOv, mainImg);
          };

          if (baseOv.getAttribute("src") !== src)
            baseOv.setAttribute("src", src);

          fitOverlayFill(baseOv, mainImg);
          baseOv.style.display = "";
        }

        sibOv.removeAttribute("src");
        sibOv.style.display = "none";

        disconnectObservers();

        roBase = new ResizeObserver(() =>
          fitOverlayFill(baseOv, mainImg)
        );

        roBase.observe(mainImg);
        roBase.observe(mainImg.parentElement);

        if (typeof refreshSwitchVisibility === "function")
          refreshSwitchVisibility();
      }

      const deb = (fn, ms = 0) => {
        let t;
        return () => {
          clearTimeout(t);
          t = setTimeout(fn, ms);
        };
      };

      const safeUpdate = deb(update, 0);

      new MutationObserver(() => safeUpdate()).observe(
        document.body,
        {
          subtree: true,
          childList: true,
          attributes: true,
          attributeFilter: ["class", "style", "src", "aria-hidden", "aria-modal"]
        }
      );

      document.addEventListener("click", () => safeUpdate(), true);
      window.addEventListener("resize", () => safeUpdate());
      document.addEventListener("v19-refresh", () => safeUpdate(), true);

      safeUpdate();
    })();
  </script>

</body>
</html>




